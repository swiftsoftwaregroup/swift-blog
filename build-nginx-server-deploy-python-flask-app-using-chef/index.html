
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Swift Software Group Blog">
      
      
      
        <link rel="canonical" href="https://blog.swiftsoftwaregroup.com/build-nginx-server-deploy-python-flask-app-using-chef/">
      
      
        <link rel="prev" href="../getting-started-flashdevelop-windows-10/">
      
      
        <link rel="next" href="../installing-an-older-version-of-xcode-alongside-xcode-9/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../feed_rss_updated.xml">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.4">
    
    
      
        <title>How to Build an NGINX Server and Deploy a Python Flask App Using Chef - Swift Software Group</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-QP5FYNH46M"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-QP5FYNH46M",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-QP5FYNH46M",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-build-an-nginx-server-and-deploy-a-python-flask-app-using-chef" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Swift Software Group" class="md-header__button md-logo" aria-label="Swift Software Group" data-md-component="logo">
      
  <img src="../images/logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Swift Software Group
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to Build an NGINX Server and Deploy a Python Flask App Using Chef
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://swiftsoftwaregroup.com" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://swiftsoftwaregroup.com/services" class="md-tabs__link">
        
  
    
  
  Services

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://swiftsoftwaregroup.com/contact-us" class="md-tabs__link">
        
  
    
  
  Contact Us

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Blog

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../archive/2023/" class="md-tabs__link">
          
  
  Archive

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../aws/" class="md-tabs__link">
          
  
  Categories

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Swift Software Group" class="md-nav__button md-logo" aria-label="Swift Software Group" data-md-component="logo">
      
  <img src="../images/logo_white.svg" alt="logo">

    </a>
    Swift Software Group
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://swiftsoftwaregroup.com" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://swiftsoftwaregroup.com/services" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://swiftsoftwaregroup.com/contact-us" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2015/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2015
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2013/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2013
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2012/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2011/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2011
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aws
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-formation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cloud-formation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cpp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../csharp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csharp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../docker-swarm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker-swarm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../dotnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dotnet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ec2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ec2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ecs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mongodb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../podman/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    podman
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ruby/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ruby
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ubuntu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vscode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    windows
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#before-you-begin" class="md-nav__link">
    <span class="md-ellipsis">
      Before You Begin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Before You Begin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-flask-application" class="md-nav__link">
    <span class="md-ellipsis">
      Test Flask Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-chocolatey" class="md-nav__link">
    <span class="md-ellipsis">
      Install Chocolatey
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-chef-development-kit-chefdk" class="md-nav__link">
    <span class="md-ellipsis">
      Install Chef Development Kit (ChefDK)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-virtualbox-and-vagrant" class="md-nav__link">
    <span class="md-ellipsis">
      Install VirtualBox and Vagrant
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-vagrant-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      Install Vagrant Plugins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#give-your-user-modify-access-to-windirsystem32driversetchosts" class="md-nav__link">
    <span class="md-ellipsis">
      Give your user Modify access to WINDIR%\System32\drivers\etc\hosts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-chef-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      Create Chef Cookbook
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ensure-the-apt-cache-is-up-to-date" class="md-nav__link">
    <span class="md-ellipsis">
      Ensure the apt cache is up to date
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ensure the apt cache is up to date">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reference-the-apt-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      Reference the apt Cookbook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-apt-cookbooks-default-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the apt cookbook's default recipe to run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-for-test-driven-development" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare for Test Driven Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare for Test Driven Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-rspec-file" class="md-nav__link">
    <span class="md-ellipsis">
      Add .rspec file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-kitchenvagrant_cachierrb-file" class="md-nav__link">
    <span class="md-ellipsis">
      Add .kitchen.vagrant_cachier.rb file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-kitchenvagrant_hostmanagerrb-file" class="md-nav__link">
    <span class="md-ellipsis">
      Add .kitchen.vagrant_hostmanager.rb file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-kitchenyml" class="md-nav__link">
    <span class="md-ellipsis">
      Update .kitchen.yml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests-manually" class="md-nav__link">
    <span class="md-ellipsis">
      Run All Tests Manually
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-a-build-system" class="md-nav__link">
    <span class="md-ellipsis">
      Setup a Build System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup a Build System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-rakefile" class="md-nav__link">
    <span class="md-ellipsis">
      Create a Rakefile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test" class="md-nav__link">
    <span class="md-ellipsis">
      Test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      List Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-application-directory" class="md-nav__link">
    <span class="md-ellipsis">
      Create Application Directory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create Application Directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_dir-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_dir recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_dirrb-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_dir.rb recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_1" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-python" class="md-nav__link">
    <span class="md-ellipsis">
      Install Python
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Python">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test_1" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-virtualenv-serverspec-type" class="md-nav__link">
    <span class="md-ellipsis">
      Create virtualenv serverspec type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reference-the-poise-python-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      Reference the poise-python cookbook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_python-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_python recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_python-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_python recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_2" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-ssh-key" class="md-nav__link">
    <span class="md-ellipsis">
      Install SSH Key
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install SSH Key">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-kitchenyml_1" class="md-nav__link">
    <span class="md-ellipsis">
      Update .kitchen.yml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-a-data-bag-secret" class="md-nav__link">
    <span class="md-ellipsis">
      Generate a Data Bag Secret
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generate a Data Bag Secret">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-environment-variable" class="md-nav__link">
    <span class="md-ellipsis">
      Create Environment Variable
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-ssh-key" class="md-nav__link">
    <span class="md-ellipsis">
      Generate SSH Key
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generate SSH Key">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-ssh-key-to-bitbucket" class="md-nav__link">
    <span class="md-ellipsis">
      Add the SSH key to Bitbucket
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-data-bag-item" class="md-nav__link">
    <span class="md-ellipsis">
      Create Data Bag Item
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encrypt-data-bag-item" class="md-nav__link">
    <span class="md-ellipsis">
      Encrypt Data Bag Item
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-ssh-wrapper-script" class="md-nav__link">
    <span class="md-ellipsis">
      Create SSH Wrapper Script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test_2" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_ssh-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_ssh recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_ssh-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_ssh recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_3" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-application-from-git" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Application From Git
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Application From Git">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reference-the-git-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      Reference the git cookbook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test_3" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_deploy-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_deploy recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_deploy-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_deploy recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_4" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-uwsgi" class="md-nav__link">
    <span class="md-ellipsis">
      Install uWSGI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install uWSGI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test_4" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-uwsgi-python-config-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create uWSGI Python Config File
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-uwsgi-service-config-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create uWSGI Service Config File
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_uwsgi-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_uwsgi recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_uwsgi-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_uwsgi recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_5" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      Install Nginx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Nginx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-an-integration-test_5" class="md-nav__link">
    <span class="md-ellipsis">
      Add an integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-nginx-site-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create Nginx Site File
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-the-my_app_nginx-recipe" class="md-nav__link">
    <span class="md-ellipsis">
      Write the my_app_nginx recipe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-my_app_nginx-recipe-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Set the my_app_nginx recipe to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-all-tests_6" class="md-nav__link">
    <span class="md-ellipsis">
      Run all tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href=".." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                        <time datetime="2016-02-13 00:00:00" class="md-ellipsis">February 13, 2016</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                          <span class="md-ellipsis">
                            
                              14 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        


<h1 id="how-to-build-an-nginx-server-and-deploy-a-python-flask-app-using-chef">How to Build an NGINX Server and Deploy a Python Flask App Using Chef</h1>
<p>In this post we show how you can use <a href="https://www.chef.io/chef/">Chef</a> to build an Ubuntu 14.04 LTS web server running Nginx, Python 2, virtualenv, uWSGI, and Flask - all done on Windows 10 host. </p>
<p>All commands are executed in PowerShell on a Windows workstation. The Chef version that is used is 12.5.1 - it is the version that comes with ChefDK 0.10.0. To avoid unexpected behavior, we recommend using those versions, when following this step-by-step guide.</p>
<h2 id="before-you-begin">Before You Begin</h2>
<h3 id="test-flask-application">Test Flask Application</h3>
<p>The test application that we use for this deployment is available in the <a href="https://github.com/vkantchev/my_flask_app">my_flask_app</a> repository. The application was created using Visual Studio 2015 with Python Tools for Visual Studio (PTVS).</p>
<h3 id="install-chocolatey">Install Chocolatey</h3>
<p>If you do not have Chocolatey, you can install it by following the instructions on <a href="https://chocolatey.org/">chocolatey.org</a>. You may also see <a href="http://www.swiftsoftwaregroup.com/use-different-cache-directory-chocolatey-packages/">this post</a> for instructions on how to set the Chocolatey cache location. </p>
<h3 id="install-chef-development-kit-chefdk">Install Chef Development Kit (ChefDK)</h3>
<p>In PowerShell as <em>Administrator</em>:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">choco</span> <span class="n">install</span> <span class="n">chefdk</span> <span class="n">-version</span> <span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
</span></code></pre></div>
<p>Find your Chef version:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">chef</span> <span class="p">-</span><span class="n">-version</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">Chef</span> <span class="n">Development</span> <span class="n">Kit</span> <span class="n">Version</span><span class="p">:</span> <span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">chef-client</span> <span class="n">version</span><span class="p">:</span> <span class="n">12</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">berks</span> <span class="n">version</span><span class="p">:</span> <span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">kitchen</span> <span class="n">version</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">2</span>
</span></code></pre></div>
<h3 id="install-virtualbox-and-vagrant">Install VirtualBox and Vagrant</h3>
<p>To install VirtualBox and Vagrant, follow the steps described in <a href="http://www.swiftsoftwaregroup.com/ubuntu-with-vagrant-and-virtualbox-on-windows/">Ubuntu with Vagrant and VirtualBox on Windows</a>.</p>
<h3 id="install-vagrant-plugins">Install Vagrant Plugins</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant-omnibus</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant-berkshelf</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant-hostmanager</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant-cachier</span>
</span></code></pre></div>
<h3 id="give-your-user-modify-access-to-windirsystem32driversetchosts">Give your user <code>Modify</code> access to <code>WINDIR%\System32\drivers\etc\hosts</code></h3>
<p>This is needed by the <a href="https://github.com/smdahlen/vagrant-hostmanager#windows-support">vagrant-hostmanager</a> Vagrant plugin. In PowerShell as <em>Administrator</em>:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nv">$acl</span> <span class="p">=</span> <span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="nv">$env:SystemRoot</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">drivers</span><span class="p">\</span><span class="n">etc</span><span class="p">\</span><span class="n">hosts</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">$ar</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">FileSystemAccessRule</span><span class="p">(</span><span class="nv">$env:username</span><span class="p">,</span> <span class="s1">&#39;Modify&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Allow&#39;</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nv">$acl</span><span class="p">.</span><span class="n">SetAccessRule</span><span class="p">(</span><span class="nv">$ar</span><span class="p">)</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nb">Set-Acl</span> <span class="n">-Path</span> <span class="nv">$env:SystemRoot</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">drivers</span><span class="p">\</span><span class="n">etc</span><span class="p">\</span><span class="n">hosts</span> <span class="n">-AclObject</span> <span class="nv">$acl</span>
</span></code></pre></div>
<h2 id="create-chef-cookbook">Create Chef Cookbook</h2>
<p>This directory will become the root of your source repository:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">cookbook</span> <span class="n">my_flask_server</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nb">cd </span><span class="n">my_flask_server</span>
</span></code></pre></div>
<h2 id="ensure-the-apt-cache-is-up-to-date">Ensure the apt cache is up to date</h2>
<h3 id="reference-the-apt-cookbook">Reference the <code>apt</code> Cookbook</h3>
<p>Add this line to <code>metadata.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;apt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 2.9.2&#39;</span>
</span></code></pre></div>
<p>To get the latest version string, run <code>knife cookbook site show apt</code>: </p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">knife</span> <span class="n">cookbook</span> <span class="n">site</span> <span class="n">show</span> <span class="n">apt</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">latest_version</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">latest_version</span><span class="p">:</span>     <span class="n">https</span><span class="p">://</span><span class="n">supermarket</span><span class="p">.</span><span class="n">chef</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">api</span><span class="p">/</span><span class="n">v1</span><span class="p">/</span><span class="n">cookbooks</span><span class="p">/</span><span class="n">apt</span><span class="p">/</span><span class="n">versions</span><span class="p">/</span><span class="n">2</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">2</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">name</span><span class="w"> </span><span class="s1">&#39;my_flask_server&#39;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">maintainer</span><span class="w"> </span><span class="s1">&#39;The Authors&#39;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">maintainer_email</span><span class="w"> </span><span class="s1">&#39;you@example.com&#39;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">license</span><span class="w"> </span><span class="s1">&#39;all_rights&#39;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">long_description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">version</span><span class="w"> </span><span class="s1">&#39;0.1.0&#39;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;apt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 2.9.2&#39;</span>
</span></code></pre></div>
<h3 id="set-the-apt-cookbooks-default-recipe-to-run">Set the apt cookbook's default recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">#</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1">#</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span></code></pre></div>
<h2 id="prepare-for-test-driven-development">Prepare for Test Driven Development</h2>
<h3 id="add-rspec-file">Add <code>.rspec</code> file</h3>
<p><div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">touch</span> <span class="p">.</span><span class="n">rspec</span>
</span></code></pre></div>
Paste this in the <code>.rspec</code> file:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>--color
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>--format documentation
</span></code></pre></div>
<h3 id="add-kitchenvagrant_cachierrb-file">Add <code>.kitchen.vagrant_cachier.rb</code> file</h3>
<p>This file will be merged within Test Kitchen's generated Vagrantfile. In it, we put the configuration for the <code>vagrant-cachier</code> plugin</p>
<p><div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">touch</span> <span class="p">.</span><span class="n">kitchen</span><span class="p">.</span><span class="n">vagrant_cachier</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
Paste this in the <code>.kitchen.vagrant_hostmanager.rb</code> file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># This requires vagrant-cachier plugin.</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># For more information see http://fgrehm.viewdocs.io/vagrant-cachier/</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1">#</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="no">Vagrant</span><span class="o">.</span><span class="n">has_plugin?</span><span class="p">(</span><span class="s2">&quot;vagrant-cachier&quot;</span><span class="p">)</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">auto_detect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:box</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="no">Vagrant</span><span class="o">.</span><span class="n">has_plugin?</span><span class="p">(</span><span class="s2">&quot;vagrant-omnibus&quot;</span><span class="p">)</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">omnibus</span><span class="o">.</span><span class="n">cache_packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">omnibus</span><span class="o">.</span><span class="n">chef_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;12.5.1&quot;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">vbguest</span><span class="o">.</span><span class="n">auto_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="add-kitchenvagrant_hostmanagerrb-file">Add <code>.kitchen.vagrant_hostmanager.rb</code> file</h3>
<p>This file will be merged within Test Kitchen's generated Vagrantfile. In it, we put the configuration for the <code>vagrant-hostmanager</code> plugin, which updates <code>C:/Windows/System32/drivers/etc/hosts</code>, and allows you to access the virtual machine by name instead of IP address, e.g. <code>default-ubuntu-1404</code>.  </p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">touch</span> <span class="p">.</span><span class="n">kitchen</span><span class="p">.</span><span class="n">vagrant_hostmanager</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Paste this in the <code>.kitchen.vagrant_hostmanager.rb</code> file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># This requires vagrant-hostmanager plugin.</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># For more information see https://github.com/smdahlen/vagrant-hostmanager</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1">#</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="no">Vagrant</span><span class="o">.</span><span class="n">has_plugin?</span><span class="p">(</span><span class="s2">&quot;vagrant-hostmanager&quot;</span><span class="p">)</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="c1"># update /ect/hosts on all running guests</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">hostmanager</span><span class="o">.</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="c1"># do not add offline guests to /etc/hosts</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">hostmanager</span><span class="o">.</span><span class="n">include_offline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="c1"># use the private ip address with ip_reslover, see below</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">hostmanager</span><span class="o">.</span><span class="n">ignore_private_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="c1"># custom IP resolver</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="c1"># get each guest&#39;s IP address by running `hostname -I` on the guest</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">hostmanager</span><span class="o">.</span><span class="n">ip_resolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">proc</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">resolving_vm</span><span class="o">|</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">ssh_info</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">vm</span><span class="o">.</span><span class="n">ssh_info</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="p">)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="sb">`vagrant ssh -c &quot;hostname -I&quot;`</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">      </span><span class="k">end</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="c1"># also update host&#39;s /ect/hosts</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">hostmanager</span><span class="o">.</span><span class="n">manage_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="update-kitchenyml">Update <code>.kitchen.yml</code></h3>
<p>Update <code>.kitchen.yml</code> to include only the <code>ubuntu-14.04</code> platform for now. Also add the data bag path and Chef version. This is how it should look at the end:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nn">---</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nt">driver</span><span class="p">:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vagrant</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">require_chef_omnibus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12.5.1</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span><span class="nt">network</span><span class="p">:</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;private_network&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dhcp&quot;</span><span class="p p-Indicator">}]</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span><span class="nt">vagrantfiles</span><span class="p">:</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.kitchen.vagrant_cachier.rb</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.kitchen.vagrant_hostmanager.rb</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="nt">provisioner</span><span class="p">:</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chef_zero</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="nt">platforms</span><span class="p">:</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-14.04</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="nt">suites</span><span class="p">:</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="nt">run_list</span><span class="p">:</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">recipe[my_flask_server::default]</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">    </span><span class="nt">attributes</span><span class="p">:</span>
</span></code></pre></div>
<h3 id="run-all-tests-manually">Run All Tests Manually</h3>
<p>Run all tests manually to verify everything works as expected. </p>
<p>First install cookbook dependencies:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">berks</span> <span class="n">install</span>
</span></code></pre></div>
<p>then run the tests:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rubocop</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">foodcritic</span> <span class="p">.</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rspec</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">kitchen</span> <span class="n">test</span> <span class="p">-</span><span class="n">-destroy</span><span class="p">=</span><span class="n">never</span>
</span></code></pre></div>
<h2 id="setup-a-build-system">Setup a Build System</h2>
<p>We will use <a href="http://rake.rubyforge.org/">Rake</a> to automate the build and test tasks. Rake already comes preinstalled in the ChefDK.</p>
<h3 id="create-a-rakefile">Create a Rakefile</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">touch</span> <span class="n">Rakefile</span>
</span></code></pre></div>
<p>Paste this into the <code>Rakefile</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># See:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1"># https://github.com/chef-cookbooks/chef-server/blob/master/Rakefile</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;rspec/core/rake_task&#39;</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;rubocop/rake_task&#39;</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;foodcritic&#39;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;kitchen&#39;</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="c1"># Style tests. Rubocop and Foodcritic</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="n">namespace</span><span class="w"> </span><span class="ss">:style</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Run Ruby style checks&#39;</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">  </span><span class="no">RuboCop</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Run Chef style checks&#39;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">  </span><span class="no">FoodCritic</span><span class="o">::</span><span class="no">Rake</span><span class="o">::</span><span class="no">LintTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:chef</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="n">t</span><span class="o">.</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">      </span><span class="n">fail_</span><span class="c1"># categories: [&#39;any&#39;]</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="k">end</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Run all style checks&#39;</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="n">task</span><span class="w"> </span><span class="ss">style</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;style:ruby&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;style:chef&#39;</span><span class="o">]</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="c1"># Rspec and ChefSpec</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Run ChefSpec examples&#39;</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="no">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:spec</span><span class="p">)</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="c1"># Integration tests. Kitchen.ci</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="n">namespace</span><span class="w"> </span><span class="ss">:integration</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Same as `chef exec kitchen test -d=never`&#39;</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">  </span><span class="n">task</span><span class="w"> </span><span class="ss">:test</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">    </span><span class="no">Kitchen</span><span class="o">.</span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Kitchen</span><span class="o">.</span><span class="n">default_file_logger</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">    </span><span class="no">Kitchen</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">instance</span><span class="o">|</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">      </span><span class="n">instance</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="ss">:never</span><span class="p">)</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="k">end</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="c1"># Default</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a><span class="n">task</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;style&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spec&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;integration:test&#39;</span><span class="o">]</span>
</span></code></pre></div>
<h3 id="test">Test</h3>
<h4 id="list-tasks">List Tasks</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span> <span class="n">-T</span>
</span></code></pre></div>
<h4 id="run-all-tests">Run all tests</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="create-application-directory">Create Application Directory</h2>
<h3 id="add-an-integration-test">Add an integration test</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">touch</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="n">my_app_dir_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Add this code to <code>my_app_dir_spec.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">  </span><span class="c1"># verify virtual environment dir</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">  </span><span class="c1"># verify uwsgi dir</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/shared/.uwsgi&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">  </span><span class="c1"># verify ssh dir</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/.ssh&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">  </span><span class="c1"># verify pip cache dir</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/.cache&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="write-the-my_app_dir-recipe">Write the <code>my_app_dir</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_dir.rb</code>. Run the following command to generate it:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_dir</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_dir_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Write out <code>recipes/my_app_dir.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">#</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="c1"># Recipe:: my_app_dir</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1">#</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="c1"># app root directory</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">  </span><span class="n">recursive</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="k">end</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># app shared directory</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/shared&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="k">end</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="c1"># for virtualenv</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="k">end</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="c1"># for uwsgi socket and uwsgi config</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/shared/.uwsgi&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="k">end</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="c1"># required by ssh</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/.ssh&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">  </span><span class="n">recursive</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="k">end</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="c1"># required by pip</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/var/www/.cache&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:create</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="w">  </span><span class="n">recursive</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_dirrb-recipe-to-run">Set the <code>my_app_dir.rb</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">#</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="c1">#</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_1">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="install-python">Install Python</h2>
<h3 id="add-an-integration-test_1">Add an integration test</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">touch</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="n">my_app_python_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Add this code to <code>my_app_python_spec.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">  </span><span class="c1"># verify system python</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">package</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">  </span><span class="c1"># verify system pip</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;which pip&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="s1">&#39;/usr/local/bin/pip&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">  </span><span class="c1"># verify system setuptools</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;which easy_install&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="s1">&#39;/usr/local/bin/easy_install&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">  </span><span class="c1"># verify system virtualenv</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;which virtualenv&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="s1">&#39;/usr/local/bin/virtualenv&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">  </span><span class="c1"># verify my_flask_app virtual environment</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="w">  </span><span class="c1"># See `helpers/serverspec/type/virtualenv.rb`</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">virtualenv</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_virtualenv</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="create-virtualenv-serverspec-type">Create <code>virtualenv</code> serverspec type</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">mkdir</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="n">helpers</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="nb">type</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">touch</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="n">helpers</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="n">type</span><span class="p">/</span><span class="n">virtualenv</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Paste this code into <code>virtualenv.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1">##############################################################################</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="c1"># You can find the original code at:</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="c1"># &lt;https://github.com/jantman/serverspec-extended-types&gt;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="c1"># Licensed under the MIT License</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="c1">##############################################################################</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="c1"># Serverspec</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="k">module</span><span class="w"> </span><span class="nn">Serverspec</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">  </span><span class="c1"># Type</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">  </span><span class="k">module</span><span class="w"> </span><span class="nn">Type</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="c1"># Virtualenv</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Virtualenv</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Base</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">      </span><span class="c1"># Test whether this appears to be a working venv</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">      </span><span class="c1">#</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">      </span><span class="c1"># Tests performed:</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">      </span><span class="c1"># - venv_path/bin/pip executable by owner?</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">      </span><span class="c1"># - venv_path/bin/python executable by owner?</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">      </span><span class="c1"># - venv_path/bin/activate readable by owner?</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">      </span><span class="c1"># - &#39;export VIRTUAL_ENV&#39; in venv_path/bin/activate?</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">      </span><span class="c1">#</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">      </span><span class="c1"># @example</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">      </span><span class="c1">#   describe virtualenv(&#39;/path/to/venv&#39;) do</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">      </span><span class="c1">#     it { should be_virtualenv }</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">      </span><span class="c1">#   end</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">      </span><span class="c1">#</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">      </span><span class="c1"># @api public</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">      </span><span class="c1"># @return [Boolean]</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">virtualenv?</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">        </span><span class="n">pip_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bin&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pip&#39;</span><span class="p">)</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">        </span><span class="n">python_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bin&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">        </span><span class="n">act_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bin&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;activate&#39;</span><span class="p">)</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;grep -q &#39;export VIRTUAL_ENV&#39; </span><span class="si">#{</span><span class="n">act_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="w">        </span><span class="vi">@runner</span><span class="o">.</span><span class="n">check_file_is_executable</span><span class="p">(</span><span class="n">pip_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;owner&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">          </span><span class="vi">@runner</span><span class="o">.</span><span class="n">check_file_is_executable</span><span class="p">(</span><span class="n">python_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;owner&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">          </span><span class="vi">@runner</span><span class="o">.</span><span class="n">check_file_is_readable</span><span class="p">(</span><span class="n">act_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;owner&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">          </span><span class="vi">@runner</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">exit_status</span><span class="o">.</span><span class="n">to_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">      </span><span class="k">end</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">    </span><span class="c1"># Serverspec Type wrapper method for Serverspec::Type::Virtualenv</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">    </span><span class="c1"># @example</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">    </span><span class="c1">#   describe virtualenv(&#39;/path/to/venv&#39;) do</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">    </span><span class="c1">#     # tests here</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">    </span><span class="c1">#   end</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">    </span><span class="c1"># @param name [String] the absolute path to the virtualenv root</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="w">    </span><span class="c1"># @api public</span>
</span><span id="__span-33-51"><a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a><span class="w">    </span><span class="c1"># @return {Serverspec::Type::Virtualenv}</span>
</span><span id="__span-33-52"><a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a><span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">virtualenv</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span id="__span-33-53"><a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a><span class="w">      </span><span class="no">Virtualenv</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span id="__span-33-54"><a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-33-55"><a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-33-56"><a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="k">end</span>
</span><span id="__span-33-57"><a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a>
</span><span id="__span-33-58"><a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a><span class="kp">include</span><span class="w"> </span><span class="no">Serverspec</span><span class="o">::</span><span class="no">Type</span>
</span></code></pre></div>
<p>Add this line to <code>test/integration/helpers/serverspec/spec_helper.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;type/virtualenv&#39;</span>
</span></code></pre></div>
<h3 id="reference-the-poise-python-cookbook">Reference the <code>poise-python</code> cookbook</h3>
<p>Add this line to <code>metadata.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;poise-python&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 1.2.1&#39;</span>
</span></code></pre></div>
<p>To get the latest version string, run <code>knife cookbook site show nginx</code>: </p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">knife</span> <span class="n">cookbook</span> <span class="n">site</span> <span class="n">show</span> <span class="n">poise-python</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">latest_version</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">latest_version</span><span class="p">:</span>     <span class="n">https</span><span class="p">://</span><span class="n">supermarket</span><span class="p">.</span><span class="n">chef</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">api</span><span class="p">/</span><span class="n">v1</span><span class="p">/</span><span class="n">cookbooks</span><span class="p">/</span><span class="n">poise-python</span><span class="p">/</span><span class="n">versions</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">1</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nb">name</span><span class="w"> </span><span class="s1">&#39;my_flask_server&#39;</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">maintainer</span><span class="w"> </span><span class="s1">&#39;The Authors&#39;</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">maintainer_email</span><span class="w"> </span><span class="s1">&#39;you@example.com&#39;</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">license</span><span class="w"> </span><span class="s1">&#39;all_rights&#39;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="n">description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="n">long_description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">version</span><span class="w"> </span><span class="s1">&#39;0.1.0&#39;</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;apt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 2.9.2&#39;</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;poise-python&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 1.2.1&#39;</span>
</span></code></pre></div>
<h3 id="write-the-my_app_python-recipe">Write the <code>my_app_python</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_python.rb</code>. Run the following command to generate it:</p>
<p><div class="language-powershell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_python</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_python_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
Write out <code>recipes/my_app_python.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1">#</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="c1"># Recipe:: my_python</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1">#</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="c1"># See https://supermarket.chef.io/cookbooks/poise-python</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="c1"># install python 2</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="n">python_runtime</span><span class="w"> </span><span class="s1">&#39;python_2&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">  </span><span class="n">version</span><span class="w"> </span><span class="s1">&#39;2&#39;</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="k">end</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="c1"># create my_flask_app virtual environment</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="n">python_virtualenv</span><span class="w"> </span><span class="s1">&#39;my_flask_app_env&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="w">  </span><span class="n">path</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2&#39;</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="w">  </span><span class="n">python</span><span class="w"> </span><span class="s1">&#39;python_2&#39;</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_python-recipe-to-run">Set the <code>my_app_python</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1">#</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="c1">#</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_2">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="install-ssh-key">Install SSH Key</h2>
<h3 id="update-kitchenyml_1">Update <code>.kitchen.yml</code></h3>
<p>Add this code to <code>.kitchen.yml</code> under <code>provisioner</code>: </p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="w">    </span><span class="nt">data_bags_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;./data_bags&quot;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">    </span><span class="nt">encrypted_data_bag_secret_key_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;%= ENV[&#39;CHEF_DATA_BAG_SECRET&#39;] %&gt;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nn">---</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="nt">driver</span><span class="p">:</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vagrant</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">  </span><span class="nt">require_chef_omnibus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12.5.1</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">  </span><span class="nt">network</span><span class="p">:</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;private_network&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dhcp&quot;</span><span class="p p-Indicator">}]</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">  </span><span class="nt">vagrantfiles</span><span class="p">:</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.kitchen.vagrant_cachier.rb</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.kitchen.vagrant_hostmanager.rb</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="nt">provisioner</span><span class="p">:</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chef_zero</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">  </span><span class="nt">data_bags_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;./data_bags&quot;</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">  </span><span class="nt">encrypted_data_bag_secret_key_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;%= ENV[&#39;CHEF_DATA_BAG_SECRET&#39;] %&gt;</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="nt">platforms</span><span class="p">:</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-14.04</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="nt">suites</span><span class="p">:</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="nt">run_list</span><span class="p">:</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">recipe[my_flask_server::default]</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">    </span><span class="nt">attributes</span><span class="p">:</span>
</span></code></pre></div>
<h3 id="generate-a-data-bag-secret">Generate a Data Bag Secret</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">mkdir</span> <span class="p">~/.</span><span class="n">chef</span>
</span></code></pre></div>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nv">$key</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[](</span><span class="n">512</span><span class="p">)</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="nv">$rng</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.RNGCryptoServiceProvider]</span><span class="p">::</span><span class="n">Create</span><span class="p">().</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="no">[Convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="s2">&quot;~/.chef/chef_data_bag_secret&quot;</span> <span class="n">-encoding</span> <span class="s2">&quot;UTF8&quot;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="no">[array]</span><span class="p">::</span><span class="n">Clear</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$key</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
</span></code></pre></div>
<p>This key will be used to encrypt sensitive cookbook information like SSH private keys. Make sure you store a copy of the <code>~/.chef/chef_data_bag_secret</code> file in a secure location.</p>
<h4 id="create-environment-variable">Create Environment Variable</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nv">$chef_secret</span> <span class="p">=</span> <span class="p">(</span><span class="nb">rvpa </span><span class="s1">&#39;~/.chef/chef_data_bag_secret&#39;</span><span class="p">).</span><span class="n">Path</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="nv">$env:CHEF_DATA_BAG_SECRET</span> <span class="p">=</span> <span class="nv">$chef_secret</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="no">[Environment]</span><span class="p">::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">&quot;CHEF_DATA_BAG_SECRET&quot;</span><span class="p">,</span> <span class="nv">$chef_secret</span><span class="p">,</span> <span class="s2">&quot;User&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="generate-ssh-key">Generate SSH Key</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">mkdir</span> <span class="p">~/.</span><span class="n">ssh</span>
</span></code></pre></div>
<p>Make sure you use an empty passphrase.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nb">pushd</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nb">cd </span><span class="p">~/.</span><span class="n">ssh</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">ssh-keygen</span> <span class="o">-f</span> <span class="n">id_my_flask_app_deploy</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="nb">popd </span>
</span></code></pre></div>
<p>If you have an existing key with a passphrase, remove the passphrase from a private key using code similar to:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">ssh-keygen</span> <span class="n">-p</span> <span class="n">-P</span> <span class="s1">&#39;PASSPHRASE&#39;</span> <span class="n">-N</span> <span class="s1">&#39;&#39;</span> <span class="o">-f</span> <span class="n">id_deploy</span>
</span></code></pre></div>
<h4 id="add-the-ssh-key-to-bitbucket">Add the SSH key to Bitbucket</h4>
<p>We will use Bitbucket to host the source code of our test application. Go ahead and fork the <a href="https://bitbucket.org/vkantchev/my_flask_app/src">my_flask_app</a> repository. </p>
<p>Then add the public part of the SSH key, <code>~/.ssh/id_my_flask_app_deploy.pub</code>, to your Bitbucket fork. See <a href="https://confluence.atlassian.com/bitbucket/use-deployment-keys-294486051.html">Use deployment keys</a> for more details. </p>
<h3 id="create-data-bag-item">Create Data Bag Item</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nv">$json</span> <span class="p">=</span> <span class="sh">@&quot;</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="sh">{</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="sh">    &quot;id&quot; : &quot;my_flask_app&quot;,</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="sh">    &quot;deploy_key&quot; : &quot;&lt;key&gt;&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="sh">}</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="sh">&quot;@</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="nv">$json</span> <span class="p">=</span> <span class="nv">$json</span> <span class="o">-replace</span> <span class="s2">&quot;&lt;key&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="no">[io.file]</span><span class="p">::</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s2">&quot;.ssh/id_my_flask_app_deploy&quot;</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">`n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">)</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="no">[io.file]</span><span class="p">::</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s2">&quot;.chef/my_flask_app.json&quot;</span><span class="p">,</span> <span class="nv">$json</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="encrypt-data-bag-item">Encrypt Data Bag Item</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">mkdir</span> <span class="p">./</span><span class="n">data_bags</span><span class="p">/</span><span class="n">secrets</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">knife</span> <span class="n">data</span> <span class="n">bag</span> <span class="n">from</span> <span class="n">file</span> <span class="n">secrets</span> <span class="p">~/.</span><span class="n">chef</span><span class="p">/</span><span class="n">my_flask_app</span><span class="p">.</span><span class="n">json</span> <span class="n">-z</span> <span class="p">-</span><span class="n">-secret</span><span class="o">-file</span> <span class="p">(</span><span class="nb">rvpa </span><span class="p">~/.</span><span class="n">chef</span><span class="p">/</span><span class="n">chef_data_bag_secret</span><span class="p">).</span><span class="n">Path</span>
</span></code></pre></div>
<h3 id="create-ssh-wrapper-script">Create SSH Wrapper Script</h3>
<p>Create <code>files/default/wrap-ssh4git.sh</code> file:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">file</span> <span class="n">wrap-ssh</span><span class="p">-</span><span class="n">4-git</span><span class="p">.</span><span class="n">sh</span>
</span></code></pre></div>
<p>Add this content to the <code>files/default/wrap-ssh-4-git.sh</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>ssh<span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;StrictHostKeyChecking=no&quot;</span><span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;/tmp/my_flask_app/ssh/id_my_flask_app_deploy&quot;</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="nv">$2</span>
</span></code></pre></div>
<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>
<h3 id="add-an-integration-test_2">Add an integration test</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">touch</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="n">my_app_ssh_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Add this code to <code>my_app_ssh_spec.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_file</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_mode</span><span class="w"> </span><span class="s1">&#39;755&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/tmp/my_flask_app/ssh/id_my_flask_app_deploy&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_file</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_mode</span><span class="w"> </span><span class="s1">&#39;600&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="write-the-my_app_ssh-recipe">Write the <code>my_app_ssh</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_ssh.rb</code>. Run the following command to generate it:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_ssh</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_ssh_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Write out <code>recipes/my_app_ssh.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1">#</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="c1"># Recipe:: my_app_ssh</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="c1">#</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="n">directory</span><span class="w"> </span><span class="s1">&#39;/tmp/my_flask_app/ssh&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">  </span><span class="n">recursive</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="k">end</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="c1"># copy git ssh wrapper</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="n">cookbook_file</span><span class="w"> </span><span class="s1">&#39;/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">  </span><span class="n">source</span><span class="w"> </span><span class="s1">&#39;wrap-ssh-4-git.sh&#39;</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="mo">0755</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a><span class="k">end</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="c1"># decrypt the private ssh key</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="n">my_flask_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;secrets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;my_flask_app&#39;</span><span class="p">)</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a><span class="k">if</span><span class="w"> </span><span class="n">my_flask_app</span><span class="o">[</span><span class="s1">&#39;deploy_key&#39;</span><span class="o">]</span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a><span class="w">  </span><span class="n">ruby_block</span><span class="w"> </span><span class="s1">&#39;decrypt `id_my_flask_app_deploy` private ssh key&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="w">    </span><span class="n">block</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="w">      </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/tmp/my_flask_app/ssh/id_my_flask_app_deploy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span><span id="__span-58-28"><a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a><span class="w">      </span><span class="n">f</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">my_flask_app</span><span class="o">[</span><span class="s1">&#39;deploy_key&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span id="__span-58-29"><a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a><span class="w">      </span><span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span><span id="__span-58-30"><a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-58-31"><a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a>
</span><span id="__span-58-32"><a id="__codelineno-58-32" name="__codelineno-58-32" href="#__codelineno-58-32"></a><span class="w">    </span><span class="n">not_if</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-33"><a id="__codelineno-58-33" name="__codelineno-58-33" href="#__codelineno-58-33"></a><span class="w">      </span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s1">&#39;/tmp/my_flask_app/ssh/id_my_flask_app_deploy&#39;</span><span class="p">)</span>
</span><span id="__span-58-34"><a id="__codelineno-58-34" name="__codelineno-58-34" href="#__codelineno-58-34"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-58-35"><a id="__codelineno-58-35" name="__codelineno-58-35" href="#__codelineno-58-35"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-58-36"><a id="__codelineno-58-36" name="__codelineno-58-36" href="#__codelineno-58-36"></a>
</span><span id="__span-58-37"><a id="__codelineno-58-37" name="__codelineno-58-37" href="#__codelineno-58-37"></a><span class="w">  </span><span class="c1"># change permissions</span>
</span><span id="__span-58-38"><a id="__codelineno-58-38" name="__codelineno-58-38" href="#__codelineno-58-38"></a><span class="w">  </span><span class="n">file</span><span class="w"> </span><span class="s1">&#39;/tmp/my_flask_app/ssh/id_my_flask_app_deploy&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-58-39"><a id="__codelineno-58-39" name="__codelineno-58-39" href="#__codelineno-58-39"></a><span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="mo">0600</span>
</span><span id="__span-58-40"><a id="__codelineno-58-40" name="__codelineno-58-40" href="#__codelineno-58-40"></a><span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-41"><a id="__codelineno-58-41" name="__codelineno-58-41" href="#__codelineno-58-41"></a><span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-58-42"><a id="__codelineno-58-42" name="__codelineno-58-42" href="#__codelineno-58-42"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-58-43"><a id="__codelineno-58-43" name="__codelineno-58-43" href="#__codelineno-58-43"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_ssh-recipe-to-run">Set the <code>my_app_ssh</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1">#</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="c1">#</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_3">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="deploy-application-from-git">Deploy Application From Git</h2>
<p>The test application is available in the <a href="https://bitbucket.org/vkantchev/my_flask_app/src">my_flask_app</a> repository on Bitbucket. Make sure you have forked it, and configured your SSH key, as explained earlier in this tutorial.</p>
<h3 id="reference-the-git-cookbook">Reference the <code>git</code> cookbook</h3>
<p>Add this line to <code>metadata.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 4.3.6&#39;</span>
</span></code></pre></div>
<p>To get the latest version string, run <code>knife cookbook site show git</code>: </p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">knife</span> <span class="n">cookbook</span> <span class="n">site</span> <span class="n">show</span> <span class="n">git</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">latest_version</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="n">latest_version</span><span class="p">:</span>     <span class="n">https</span><span class="p">://</span><span class="n">supermarket</span><span class="p">.</span><span class="n">chef</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">api</span><span class="p">/</span><span class="n">v1</span><span class="p">/</span><span class="n">cookbooks</span><span class="p">/</span><span class="n">git</span><span class="p">/</span><span class="n">versions</span><span class="p">/</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">6</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="nb">name</span><span class="w"> </span><span class="s1">&#39;my_flask_server&#39;</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">maintainer</span><span class="w"> </span><span class="s1">&#39;The Authors&#39;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">maintainer_email</span><span class="w"> </span><span class="s1">&#39;you@example.com&#39;</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="n">license</span><span class="w"> </span><span class="s1">&#39;all_rights&#39;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="n">description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="n">long_description</span><span class="w"> </span><span class="s1">&#39;Installs/Configures my_flask_server&#39;</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="n">version</span><span class="w"> </span><span class="s1">&#39;0.1.0&#39;</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;apt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 2.9.2&#39;</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;poise-python&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 1.2.1&#39;</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="n">depends</span><span class="w"> </span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 4.3.6&#39;</span>
</span></code></pre></div>
<h3 id="add-an-integration-test_3">Add an integration test</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">touch</span> <span class="n">test</span><span class="p">/</span><span class="n">integration</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">serverspec</span><span class="p">/</span><span class="n">my_app_deploy_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Add this code to <code>my_app_deploy_spec.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_deploy&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="w">  </span><span class="c1"># verify git deployment</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/current&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_symlink</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/current/app.py&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="w">  </span><span class="c1"># verify requirements.txt has been processed</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="w">  </span><span class="c1"># i.e. local python packages like `Flask` have been installed</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2/bin/pip list&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="s1">&#39;Flask&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="write-the-my_app_deploy-recipe">Write the <code>my_app_deploy</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_deploy.rb</code>. Run the following command to generate it:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_deploy</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_deploy_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Write out <code>recipes/my_app_deploy.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1">#</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="c1"># Recipe:: my_app_deploy</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="c1">#</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;git::default&#39;</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="c1"># checkout app from git repo / master branch</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="c1"># creates `releases`, and `current` directories</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="c1"># links `current` to latest revision</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="n">deploy_revision</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:deploy</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">  </span><span class="n">repo</span><span class="w"> </span><span class="s1">&#39;ssh://git@bitbucket.org/vkantchev/my_flask_app.git&#39;</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="w">  </span><span class="n">branch</span><span class="w"> </span><span class="s1">&#39;master&#39;</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="w">  </span><span class="n">ssh_wrapper</span><span class="w"> </span><span class="s1">&#39;/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh&#39;</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="w">  </span><span class="n">purge_before_symlink</span><span class="w"> </span><span class="o">[]</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="w">  </span><span class="n">create_dirs_before_symlink</span><span class="w"> </span><span class="o">[]</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="w">  </span><span class="n">symlinks</span><span class="p">({})</span>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="w">  </span><span class="n">migrate</span><span class="w"> </span><span class="kp">false</span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="w">  </span><span class="n">symlink_before_migrate</span><span class="p">({})</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="k">end</span>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a><span class="c1"># install python packages in `my_flask_app_env` via pip</span>
</span><span id="__span-68-33"><a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a><span class="c1"># `my_flask_app_env` is defined in the `my_app_python.rb`</span>
</span><span id="__span-68-34"><a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a><span class="n">pip_requirements</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/current/requirements.txt&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-68-35"><a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a><span class="w">  </span><span class="n">virtualenv</span><span class="w"> </span><span class="s1">&#39;my_flask_app_env&#39;</span>
</span><span id="__span-68-36"><a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-68-37"><a id="__codelineno-68-37" name="__codelineno-68-37" href="#__codelineno-68-37"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-68-38"><a id="__codelineno-68-38" name="__codelineno-68-38" href="#__codelineno-68-38"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:install</span>
</span><span id="__span-68-39"><a id="__codelineno-68-39" name="__codelineno-68-39" href="#__codelineno-68-39"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_deploy-recipe-to-run">Set the <code>my_app_deploy</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_deploy&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1">#</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="c1">#</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_deploy&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_4">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="install-uwsgi">Install uWSGI</h2>
<h3 id="add-an-integration-test_4">Add an integration test</h3>
<p>Create <code>test/integration/default/serverspec/my_app_uwsgi_spec.rb</code></p>
<p>Add this code to <code>my_app_uwsgi_spec.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_uwsgi&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">  </span><span class="c1"># verify uWSGI package</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;/var/www/my_flask_app/shared/.env2/bin/pip list&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="s1">&#39;uWSGI&#39;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="w">  </span><span class="c1"># verify my_flask_app uWSGI serice</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;my_flask_app&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_enabled</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_running</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="create-uwsgi-python-config-file">Create uWSGI Python Config File</h3>
<p>Create <code>files/default/uwsgi/my_flask_app.ini</code> file:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">mkdir</span> <span class="n">files</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">uwsgi</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">file</span> <span class="n">uwsgi</span><span class="p">/</span><span class="n">my_flask_app</span><span class="p">.</span><span class="n">ini</span>
</span></code></pre></div>
<p>Add this content to the <code>files/default/uwsgi/my_flask_app.ini</code>:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># See:</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="c1"># http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="c1"># http://uwsgi-docs.readthedocs.org/en/latest/Upstart.html</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="c1"># http://uwsgi-docs.readthedocs.org/en/latest/Options.html#plugin-python</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="k">[uwsgi]</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="c1"># socket configuration</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="na">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/var/www/my_flask_app/shared/.uwsgi/my_flask_app.sock</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="na">chmod-socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">664</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="na">vacuum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="c1"># process configuration</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="na">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="na">processes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="na">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="na">die-on-term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="c1"># app configuration</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="c1"># virtual environment</span>
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="na">virtualenv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/var/www/my_flask_app/shared/.env2</span>
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>
</span><span id="__span-74-23"><a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="c1"># call the app instance from the app.py module</span>
</span><span id="__span-74-24"><a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a><span class="na">chdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/var/www/my_flask_app/current</span>
</span><span id="__span-74-25"><a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="na">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">app</span>
</span><span id="__span-74-26"><a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="na">callable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">app</span>
</span></code></pre></div>
<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>
<h3 id="create-uwsgi-service-config-file">Create uWSGI Service Config File</h3>
<p>Create <code>files/default/uwsgi/my_flask_app.conf</code> file:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">file</span> <span class="n">uwsgi</span><span class="p">/</span><span class="n">my_flask_app</span><span class="p">.</span><span class="n">conf</span>
</span></code></pre></div>
<p>Add this content to the <code>files/default/uwsgi/my_flask_app.conf</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>description &quot;uWSGI instance to serve my_flask_app&quot;
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>start on runlevel [2345]
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>stop on runlevel [!2345]
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>setuid www-data
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>setgid www-data
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>script
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>  cd /var/www/my_flask_app/shared
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>  . .env2/bin/activate
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>  uwsgi --ini .uwsgi/my_flask_app.ini
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>end script
</span></code></pre></div>
<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>
<h3 id="write-the-my_app_uwsgi-recipe">Write the <code>my_app_uwsgi</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_uwsgi.rb</code>. Run the following command to generate it:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_uwsgi</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_uwsgi_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Write out <code>recipes/my_app_uwsgi.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1">#</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="c1"># Recipe:: my_app_uwsgi</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="c1">#</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="c1"># Install the uwsgi package in virtual environment using pip</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="c1"># See https://supermarket.chef.io/cookbooks/poise-python</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="c1"># install uwsgi python package</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="n">python_package</span><span class="w"> </span><span class="s1">&#39;uwsgi&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="w">  </span><span class="n">virtualenv</span><span class="w"> </span><span class="s1">&#39;my_flask_app_env&#39;</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;www-data&#39;</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a><span class="k">end</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a><span class="c1"># my_flask_app uWSGI configuration</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="n">cookbook_file</span><span class="w"> </span><span class="s1">&#39;/var/www/my_flask_app/shared/.uwsgi/my_flask_app.ini&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a><span class="w">  </span><span class="n">source</span><span class="w"> </span><span class="s1">&#39;uwsgi/my_flask_app.ini&#39;</span>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a><span class="w">  </span><span class="n">owner</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a><span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="mo">0644</span>
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a><span class="k">end</span>
</span><span id="__span-78-24"><a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>
</span><span id="__span-78-25"><a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a><span class="c1"># create my_flask_app uWSGI service</span>
</span><span id="__span-78-26"><a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a><span class="n">cookbook_file</span><span class="w"> </span><span class="s1">&#39;/etc/init/my_flask_app.conf&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-78-27"><a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a><span class="w">  </span><span class="n">source</span><span class="w"> </span><span class="s1">&#39;uwsgi/my_flask_app.conf&#39;</span>
</span><span id="__span-78-28"><a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a><span class="w">  </span><span class="n">owner</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-78-29"><a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-78-30"><a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a><span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="mo">0644</span>
</span><span id="__span-78-31"><a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a><span class="k">end</span>
</span><span id="__span-78-32"><a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>
</span><span id="__span-78-33"><a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a><span class="c1"># start my_flask_app uWSGI service</span>
</span><span id="__span-78-34"><a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a><span class="n">service</span><span class="w"> </span><span class="s1">&#39;my_flask_app&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-78-35"><a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a><span class="w">  </span><span class="n">provider</span><span class="w"> </span><span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Upstart</span>
</span><span id="__span-78-36"><a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a><span class="w">  </span><span class="n">supports</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">restart</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">reload</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-78-37"><a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="o">[</span><span class="ss">:enable</span><span class="p">,</span><span class="w"> </span><span class="ss">:start</span><span class="o">]</span>
</span><span id="__span-78-38"><a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_uwsgi-recipe-to-run">Set the <code>my_app_uwsgi</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_uwsgi&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1">#</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="c1">#</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_deploy&#39;</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_uwsgi&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_5">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<h2 id="install-nginx">Install Nginx</h2>
<h3 id="add-an-integration-test_5">Add an integration test</h3>
<p>Rename <code>test/integration/default/serverspec/default_spec.rb</code> to <code>test/integration/default/serverspec/my_app_nginx_spec.rb</code> </p>
<p>Replace the contents of <code>my_app_nginx_spec.rb</code> with this code:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;spec_helper&#39;</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="n">describe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_nginx&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="w">  </span><span class="c1"># Serverspec examples can be found at</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="w">  </span><span class="c1"># http://serverspec.org/resource_types.html</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="w">  </span><span class="c1"># verify nginx package</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">package</span><span class="p">(</span><span class="s1">&#39;nginx&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="w">  </span><span class="c1"># verify nginx serice</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;nginx&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_enabled</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a><span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_running</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="create-nginx-site-file">Create Nginx Site File</h3>
<p>Create <code>files/default/nginx/my_flask_app</code> file:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">mkdir</span> <span class="n">files</span><span class="p">/</span><span class="k">default</span><span class="p">/</span><span class="n">nginx</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">file</span> <span class="n">nginx</span><span class="p">/</span><span class="n">my_flask_app</span>
</span></code></pre></div>
<p>Add this content to the <code>files/default/nginx/my_flask_app</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>server {
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>  listen 80 default_server;
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>  listen [::]:80 default_server ipv6only=on;
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>  # Make site accessible from http://localhost/
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>  server_name localhost;
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>  location / {
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>    include uwsgi_params;
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>    uwsgi_pass unix:/var/www/my_flask_app/shared/.uwsgi/my_flask_app.sock;
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>  }
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>}
</span></code></pre></div>
<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>
<h3 id="write-the-my_app_nginx-recipe">Write the <code>my_app_nginx</code> recipe</h3>
<p>The first step is to create the recipe file, <code>my_app_nginx.rb</code>. Run the following command to generate it:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="n">chef</span> <span class="n">generate</span> <span class="n">recipe</span> <span class="n">my_app_nginx</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="nb">rm </span><span class="n">spec</span><span class="p">/</span><span class="n">unit</span><span class="p">/</span><span class="n">recipes</span><span class="p">/</span><span class="n">my_app_nginx_spec</span><span class="p">.</span><span class="n">rb</span>
</span></code></pre></div>
<p>Write out <code>recipes/my_app_nginx.rb</code> like this:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1">#</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="c1"># Recipe:: my_nginx</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="c1">#</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="c1"># install nginx</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="n">package</span><span class="w"> </span><span class="s1">&#39;nginx&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">  </span><span class="ss">:upgrade</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="k">end</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="c1"># start nginx service</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="n">service</span><span class="w"> </span><span class="s1">&#39;nginx&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="w">  </span><span class="n">supports</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">restart</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">reload</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="o">[</span><span class="ss">:enable</span><span class="p">,</span><span class="w"> </span><span class="ss">:start</span><span class="o">]</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="k">end</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="c1"># Uncomment to use a custom nginx.conf</span>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a><span class="c1"># cookbook_file &#39;/etc/nginx/nginx.conf&#39; do</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="c1">#   source &#39;nginx/nginx.conf&#39;</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a><span class="c1">#   mode 0640</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="c1">#   owner &#39;root&#39;</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a><span class="c1">#   group &#39;root&#39;</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a><span class="c1">#   notifies :restart, &#39;service[nginx]&#39;</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a><span class="c1"># end</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a><span class="c1"># disable default site</span>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a><span class="n">link</span><span class="w"> </span><span class="s1">&#39;/etc/nginx/sites-enabled/default&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="ss">:delete</span>
</span><span id="__span-86-30"><a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a><span class="w">  </span><span class="n">only_if</span><span class="w"> </span><span class="s1">&#39;test -L /etc/nginx/sites-enabled/default&#39;</span>
</span><span id="__span-86-31"><a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a><span class="w">  </span><span class="n">notifies</span><span class="w"> </span><span class="ss">:restart</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;service[nginx]&#39;</span>
</span><span id="__span-86-32"><a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a><span class="k">end</span>
</span><span id="__span-86-33"><a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a>
</span><span id="__span-86-34"><a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a><span class="c1"># add my_flask_app site</span>
</span><span id="__span-86-35"><a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a><span class="n">cookbook_file</span><span class="w"> </span><span class="s1">&#39;/etc/nginx/sites-available/my_flask_app&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-86-36"><a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a><span class="w">  </span><span class="n">source</span><span class="w"> </span><span class="s1">&#39;nginx/my_flask_app&#39;</span>
</span><span id="__span-86-37"><a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a><span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="mo">0640</span>
</span><span id="__span-86-38"><a id="__codelineno-86-38" name="__codelineno-86-38" href="#__codelineno-86-38"></a><span class="w">  </span><span class="n">owner</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-86-39"><a id="__codelineno-86-39" name="__codelineno-86-39" href="#__codelineno-86-39"></a><span class="w">  </span><span class="n">group</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
</span><span id="__span-86-40"><a id="__codelineno-86-40" name="__codelineno-86-40" href="#__codelineno-86-40"></a><span class="k">end</span>
</span><span id="__span-86-41"><a id="__codelineno-86-41" name="__codelineno-86-41" href="#__codelineno-86-41"></a>
</span><span id="__span-86-42"><a id="__codelineno-86-42" name="__codelineno-86-42" href="#__codelineno-86-42"></a><span class="c1"># enable my_flask_app site</span>
</span><span id="__span-86-43"><a id="__codelineno-86-43" name="__codelineno-86-43" href="#__codelineno-86-43"></a><span class="n">link</span><span class="w"> </span><span class="s1">&#39;/etc/nginx/sites-enabled/my_flask_app&#39;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-86-44"><a id="__codelineno-86-44" name="__codelineno-86-44" href="#__codelineno-86-44"></a><span class="w">  </span><span class="n">to</span><span class="w"> </span><span class="s1">&#39;/etc/nginx/sites-available/my_flask_app&#39;</span>
</span><span id="__span-86-45"><a id="__codelineno-86-45" name="__codelineno-86-45" href="#__codelineno-86-45"></a><span class="w">  </span><span class="n">notifies</span><span class="w"> </span><span class="ss">:restart</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;service[nginx]&#39;</span>
</span><span id="__span-86-46"><a id="__codelineno-86-46" name="__codelineno-86-46" href="#__codelineno-86-46"></a><span class="k">end</span>
</span></code></pre></div>
<h3 id="set-the-my_app_nginx-recipe-to-run">Set the <code>my_app_nginx</code> recipe to run</h3>
<p>Add this line to <code>recipes/default.rb</code>:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_nginx&#39;</span>
</span></code></pre></div>
<p>Here is the complete file:</p>
<div class="language-ruby highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1">#</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="c1"># Cookbook Name:: my_flask_server</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="c1"># Recipe:: default</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="c1">#</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;apt::default&#39;</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_dir&#39;</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_python&#39;</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_ssh&#39;</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_deploy&#39;</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_uwsgi&#39;</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="n">include_recipe</span><span class="w"> </span><span class="s1">&#39;my_flask_server::my_app_nginx&#39;</span>
</span></code></pre></div>
<h3 id="run-all-tests_6">Run all tests</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="n">chef</span> <span class="n">exec</span> <span class="n">rake</span>
</span></code></pre></div>
<p>Open a browser and navigate to <code>http://default-ubuntu-1404/</code>. You should see the "Hello World!" page of the my_flask application.</p>







  
  



  


  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2001 - 2024 Swift Software Group, Inc.
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.top", "search.suggest", "search.share", "search.highlight"], "search": "../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.7389ff0e.min.js"></script>
      
    
  </body>
</html>