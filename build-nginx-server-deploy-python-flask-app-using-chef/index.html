<!DOCTYPE html>
<html lang="en">
<title>How to Build an NGINX Server and Deploy a Python Flask App Using Chef | Swift Software Group</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Val Kantchev">
<meta name="generator" content="Jekyll v4.2.0">
<link rel="canonical" href="/build-nginx-server-deploy-python-flask-app-using-chef/">

<link rel="stylesheet" href="/assets/css/frame.css">

<link rel="stylesheet" href="/assets/css/classes.css">
<link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Swift Software Group">

<script src="//swiftsoftwaregroup.disqus.com/embed.js" async></script>





<header>
  <a href="/" class="title">Swift Software Group</a>
  <nav><a aria-label="Blog" href="/" ><span aria-hidden="true">Blog</span></a><a aria-label="" href="" ><span aria-hidden="true"></span></a></nav>

</header>

<article>
  <header>
  <h1><a href="/build-nginx-server-deploy-python-flask-app-using-chef/">How to Build an NGINX Server and Deploy a Python Flask App Using Chef</a></h1><time datetime="2016-02-13T00:00:00-08:00">February 13, 2016</time>
</header>

  <p>In this post we show how you can use <a href="https://www.chef.io/chef/">Chef</a> to build an Ubuntu 14.04 LTS web server running Nginx, Python 2, virtualenv, uWSGI, and Flask - all done on Windows 10 host.</p>

<p>All commands are executed in PowerShell on a Windows workstation. The Chef version that is used is 12.5.1 - it is the version that comes with ChefDK 0.10.0. To avoid unexpected behavior, we recommend using those versions, when following this step-by-step guide.</p>

<h2 id="before-you-begin">Before You Begin</h2>

<h3 id="test-flask-application">Test Flask Application</h3>

<p>The test application that we use for this deployment is available in the <a href="https://github.com/vkantchev/my_flask_app">my_flask_app</a> repository. The application was created using Visual Studio 2015 with Python Tools for Visual Studio (PTVS).</p>

<h3 id="install-chocolatey">Install Chocolatey</h3>

<p>If you do not have Chocolatey, you can install it by following the instructions on <a href="https://chocolatey.org/">chocolatey.org</a>. You may also see <a href="http://www.swiftsoftwaregroup.com/use-different-cache-directory-chocolatey-packages/">this post</a> for instructions on how to set the Chocolatey cache location.</p>

<h3 id="install-chef-development-kit-chefdk">Install Chef Development Kit (ChefDK)</h3>

<p>In PowerShell as <em>Administrator</em>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">choco</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">chefdk</span><span class="w"> </span><span class="nt">-version</span><span class="w"> </span><span class="nx">0.10.0.1</span><span class="w">
</span></code></pre></div></div>

<p>Find your Chef version:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nt">--version</span><span class="w">

</span><span class="n">Chef</span><span class="w"> </span><span class="nx">Development</span><span class="w"> </span><span class="nx">Kit</span><span class="w"> </span><span class="nx">Version:</span><span class="w"> </span><span class="nx">0.10.0</span><span class="w">
</span><span class="n">chef-client</span><span class="w"> </span><span class="nx">version:</span><span class="w"> </span><span class="nx">12.5.1</span><span class="w">
</span><span class="n">berks</span><span class="w"> </span><span class="nx">version:</span><span class="w"> </span><span class="nx">4.0.1</span><span class="w">
</span><span class="n">kitchen</span><span class="w"> </span><span class="nx">version:</span><span class="w"> </span><span class="nx">1.4.2</span><span class="w">
</span></code></pre></div></div>

<h3 id="install-virtualbox-and-vagrant">Install VirtualBox and Vagrant</h3>

<p>To install VirtualBox and Vagrant, follow the steps described in <a href="http://www.swiftsoftwaregroup.com/ubuntu-with-vagrant-and-virtualbox-on-windows/">Ubuntu with Vagrant and VirtualBox on Windows</a>.</p>

<h3 id="install-vagrant-plugins">Install Vagrant Plugins</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vagrant</span><span class="w"> </span><span class="nx">plugin</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">vagrant-omnibus</span><span class="w">
</span><span class="n">vagrant</span><span class="w"> </span><span class="nx">plugin</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">vagrant-berkshelf</span><span class="w">
</span><span class="n">vagrant</span><span class="w"> </span><span class="nx">plugin</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">vagrant-hostmanager</span><span class="w">
</span><span class="n">vagrant</span><span class="w"> </span><span class="nx">plugin</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">vagrant-cachier</span><span class="w">
</span></code></pre></div></div>

<h3 id="give-your-user-modify-access-to-windirsystem32driversetchosts">Give your user <code class="language-plaintext highlighter-rouge">Modify</code> access to <code class="language-plaintext highlighter-rouge">WINDIR%\System32\drivers\etc\hosts</code></h3>

<p>This is needed by the <a href="https://github.com/smdahlen/vagrant-hostmanager#windows-support">vagrant-hostmanager</a> Vagrant plugin. In PowerShell as <em>Administrator</em>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$acl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Acl</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SystemRoot</span><span class="nx">\System32\drivers\etc\hosts</span><span class="w">
</span><span class="nv">$ar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Security.AccessControl.FileSystemAccessRule</span><span class="p">(</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">username</span><span class="p">,</span><span class="w"> </span><span class="s1">'Modify'</span><span class="p">,</span><span class="w"> </span><span class="s1">'None'</span><span class="p">,</span><span class="w"> </span><span class="s1">'None'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Allow'</span><span class="p">)</span><span class="w">
</span><span class="nv">$acl</span><span class="o">.</span><span class="nf">SetAccessRule</span><span class="p">(</span><span class="nv">$ar</span><span class="p">)</span><span class="w">
</span><span class="n">Set-Acl</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SystemRoot</span><span class="nx">\System32\drivers\etc\hosts</span><span class="w"> </span><span class="nt">-AclObject</span><span class="w"> </span><span class="nv">$acl</span><span class="w">
</span></code></pre></div></div>

<h2 id="create-chef-cookbook">Create Chef Cookbook</h2>

<p>This directory will become the root of your source repository:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">cookbook</span><span class="w"> </span><span class="nx">my_flask_server</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">my_flask_server</span><span class="w">
</span></code></pre></div></div>

<h2 id="ensure-the-apt-cache-is-up-to-date">Ensure the apt cache is up to date</h2>

<h3 id="reference-the-apt-cookbook">Reference the <code class="language-plaintext highlighter-rouge">apt</code> Cookbook</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">metadata.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depends</span> <span class="s1">'apt'</span><span class="p">,</span> <span class="s1">'~&gt; 2.9.2'</span>
</code></pre></div></div>

<p>To get the latest version string, run <code class="language-plaintext highlighter-rouge">knife cookbook site show apt</code>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">knife</span><span class="w"> </span><span class="nx">cookbook</span><span class="w"> </span><span class="nx">site</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">apt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="nx">latest_version</span><span class="w">
</span><span class="n">latest_version:</span><span class="w">     </span><span class="nx">https://supermarket.chef.io/api/v1/cookbooks/apt/versions/2.9.2</span><span class="w">
</span></code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">name</span> <span class="s1">'my_flask_server'</span>
<span class="n">maintainer</span> <span class="s1">'The Authors'</span>
<span class="n">maintainer_email</span> <span class="s1">'you@example.com'</span>
<span class="n">license</span> <span class="s1">'all_rights'</span>
<span class="n">description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">long_description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">version</span> <span class="s1">'0.1.0'</span>

<span class="n">depends</span> <span class="s1">'apt'</span><span class="p">,</span> <span class="s1">'~&gt; 2.9.2'</span>
</code></pre></div></div>

<h3 id="set-the-apt-cookbooks-default-recipe-to-run">Set the apt cookbook’s default recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'apt::default'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>
</code></pre></div></div>

<h2 id="prepare-for-test-driven-development">Prepare for Test Driven Development</h2>

<h3 id="add-rspec-file">Add <code class="language-plaintext highlighter-rouge">.rspec</code> file</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="o">.</span><span class="nf">rspec</span><span class="w">
</span></code></pre></div></div>
<p>Paste this in the <code class="language-plaintext highlighter-rouge">.rspec</code> file:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--color
--format documentation
</code></pre></div></div>

<h3 id="add-kitchenvagrant_cachierrb-file">Add <code class="language-plaintext highlighter-rouge">.kitchen.vagrant_cachier.rb</code> file</h3>

<p>This file will be merged within Test Kitchen’s generated Vagrantfile. In it, we put the configuration for the <code class="language-plaintext highlighter-rouge">vagrant-cachier</code> plugin</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="o">.</span><span class="nf">kitchen</span><span class="o">.</span><span class="nf">vagrant_cachier</span><span class="o">.</span><span class="nf">rb</span><span class="w">
</span></code></pre></div></div>
<p>Paste this in the <code class="language-plaintext highlighter-rouge">.kitchen.vagrant_hostmanager.rb</code> file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This requires vagrant-cachier plugin.</span>
<span class="c1"># For more information see http://fgrehm.viewdocs.io/vagrant-cachier/</span>
<span class="c1">#</span>
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="k">if</span> <span class="no">Vagrant</span><span class="p">.</span><span class="nf">has_plugin?</span><span class="p">(</span><span class="s2">"vagrant-cachier"</span><span class="p">)</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">auto_detect</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">scope</span> <span class="o">=</span> <span class="ss">:box</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="no">Vagrant</span><span class="p">.</span><span class="nf">has_plugin?</span><span class="p">(</span><span class="s2">"vagrant-omnibus"</span><span class="p">)</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">omnibus</span><span class="p">.</span><span class="nf">cache_packages</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">omnibus</span><span class="p">.</span><span class="nf">chef_version</span> <span class="o">=</span> <span class="s2">"12.5.1"</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vbguest</span><span class="p">.</span><span class="nf">auto_update</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="add-kitchenvagrant_hostmanagerrb-file">Add <code class="language-plaintext highlighter-rouge">.kitchen.vagrant_hostmanager.rb</code> file</h3>

<p>This file will be merged within Test Kitchen’s generated Vagrantfile. In it, we put the configuration for the <code class="language-plaintext highlighter-rouge">vagrant-hostmanager</code> plugin, which updates <code class="language-plaintext highlighter-rouge">C:/Windows/System32/drivers/etc/hosts</code>, and allows you to access the virtual machine by name instead of IP address, e.g. <code class="language-plaintext highlighter-rouge">default-ubuntu-1404</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="o">.</span><span class="nf">kitchen</span><span class="o">.</span><span class="nf">vagrant_hostmanager</span><span class="o">.</span><span class="nf">rb</span><span class="w">
</span></code></pre></div></div>

<p>Paste this in the <code class="language-plaintext highlighter-rouge">.kitchen.vagrant_hostmanager.rb</code> file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This requires vagrant-hostmanager plugin.</span>
<span class="c1"># For more information see https://github.com/smdahlen/vagrant-hostmanager</span>
<span class="c1">#</span>
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="k">if</span> <span class="no">Vagrant</span><span class="p">.</span><span class="nf">has_plugin?</span><span class="p">(</span><span class="s2">"vagrant-hostmanager"</span><span class="p">)</span>
    <span class="c1"># update /ect/hosts on all running guests</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">hostmanager</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># do not add offline guests to /etc/hosts</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">hostmanager</span><span class="p">.</span><span class="nf">include_offline</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># use the private ip address with ip_reslover, see below</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">hostmanager</span><span class="p">.</span><span class="nf">ignore_private_ip</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># custom IP resolver</span>
    <span class="c1"># get each guest's IP address by running `hostname -I` on the guest</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">hostmanager</span><span class="p">.</span><span class="nf">ip_resolver</span> <span class="o">=</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">vm</span><span class="p">,</span> <span class="n">resolving_vm</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">hostname</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm</span><span class="p">.</span><span class="nf">ssh_info</span> <span class="o">&amp;&amp;</span> <span class="n">vm</span><span class="p">.</span><span class="nf">ssh_info</span><span class="p">[</span><span class="ss">:host</span><span class="p">])</span>
        <span class="sb">`vagrant ssh -c "hostname -I"`</span><span class="p">.</span><span class="nf">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># also update host's /ect/hosts</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">hostmanager</span><span class="p">.</span><span class="nf">manage_host</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="update-kitchenyml">Update <code class="language-plaintext highlighter-rouge">.kitchen.yml</code></h3>

<p>Update <code class="language-plaintext highlighter-rouge">.kitchen.yml</code> to include only the <code class="language-plaintext highlighter-rouge">ubuntu-14.04</code> platform for now. Also add the data bag path and Chef version. This is how it should look at the end:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">driver</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vagrant</span>
  <span class="na">require_chef_omnibus</span><span class="pi">:</span> <span class="s">12.5.1</span>
  <span class="na">network</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">private_network"</span><span class="pi">,</span> <span class="pi">{</span><span class="nv">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dhcp"</span><span class="pi">}]</span>
  <span class="na">vagrantfiles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.kitchen.vagrant_cachier.rb</span>
    <span class="pi">-</span> <span class="s">.kitchen.vagrant_hostmanager.rb</span>

<span class="na">provisioner</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">chef_zero</span>

<span class="na">platforms</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ubuntu-14.04</span>

<span class="na">suites</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">run_list</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">recipe[my_flask_server::default]</span>
    <span class="na">attributes</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="run-all-tests-manually">Run All Tests Manually</h3>

<p>Run all tests manually to verify everything works as expected.</p>

<p>First install cookbook dependencies:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">berks</span><span class="w"> </span><span class="nx">install</span><span class="w">
</span></code></pre></div></div>

<p>then run the tests:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rubocop</span><span class="w">
</span><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">foodcritic</span><span class="w"> </span><span class="o">.</span><span class="w">
</span><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rspec</span><span class="w">
</span><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">kitchen</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nt">--destroy</span><span class="o">=</span><span class="n">never</span><span class="w">
</span></code></pre></div></div>

<h2 id="setup-a-build-system">Setup a Build System</h2>

<p>We will use <a href="http://rake.rubyforge.org/">Rake</a> to automate the build and test tasks. Rake already comes preinstalled in the ChefDK.</p>

<h3 id="create-a-rakefile">Create a Rakefile</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="nx">Rakefile</span><span class="w">
</span></code></pre></div></div>

<p>Paste this into the <code class="language-plaintext highlighter-rouge">Rakefile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># See:</span>
<span class="c1"># https://github.com/chef-cookbooks/chef-server/blob/master/Rakefile</span>

<span class="nb">require</span> <span class="s1">'rspec/core/rake_task'</span>
<span class="nb">require</span> <span class="s1">'rubocop/rake_task'</span>
<span class="nb">require</span> <span class="s1">'foodcritic'</span>
<span class="nb">require</span> <span class="s1">'kitchen'</span>

<span class="c1"># Style tests. Rubocop and Foodcritic</span>
<span class="n">namespace</span> <span class="ss">:style</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Run Ruby style checks'</span>
  <span class="no">RuboCop</span><span class="o">::</span><span class="no">RakeTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span>

  <span class="n">desc</span> <span class="s1">'Run Chef style checks'</span>
  <span class="no">FoodCritic</span><span class="o">::</span><span class="no">Rake</span><span class="o">::</span><span class="no">LintTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:chef</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">fail_tags: </span><span class="p">[</span><span class="s1">'any'</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s1">'Run all style checks'</span>
<span class="n">task</span> <span class="ss">style: </span><span class="p">[</span><span class="s1">'style:ruby'</span><span class="p">,</span> <span class="s1">'style:chef'</span><span class="p">]</span>

<span class="c1"># Rspec and ChefSpec</span>
<span class="n">desc</span> <span class="s1">'Run ChefSpec examples'</span>
<span class="no">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:spec</span><span class="p">)</span>

<span class="c1"># Integration tests. Kitchen.ci</span>
<span class="n">namespace</span> <span class="ss">:integration</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Same as `chef exec kitchen test -d=never`'</span>
  <span class="n">task</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="no">Kitchen</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Kitchen</span><span class="p">.</span><span class="nf">default_file_logger</span>
    <span class="no">Kitchen</span><span class="o">::</span><span class="no">Config</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">instances</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">instance</span><span class="o">|</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="ss">:never</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Default</span>
<span class="n">task</span> <span class="ss">default: </span><span class="p">[</span><span class="s1">'style'</span><span class="p">,</span> <span class="s1">'spec'</span><span class="p">,</span> <span class="s1">'integration:test'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="test">Test</h3>

<h4 id="list-tasks">List Tasks</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w"> </span><span class="nt">-T</span><span class="w">
</span></code></pre></div></div>

<h4 id="run-all-tests">Run all tests</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="create-application-directory">Create Application Directory</h2>

<h3 id="add-an-integration-test">Add an integration test</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="nx">test/integration/default/serverspec/my_app_dir_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Add this code to <code class="language-plaintext highlighter-rouge">my_app_dir_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_dir'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="c1"># verify virtual environment dir</span>
  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/shared/.env2'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_directory</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify uwsgi dir</span>
  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/shared/.uwsgi'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_directory</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify ssh dir</span>
  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/.ssh'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_directory</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify pip cache dir</span>
  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/.cache'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_directory</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="write-the-my_app_dir-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_dir</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_dir.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_dir</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_dir_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_dir.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_app_dir</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="c1"># app root directory</span>
<span class="n">directory</span> <span class="s1">'/var/www/my_flask_app'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">recursive</span> <span class="kp">true</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># app shared directory</span>
<span class="n">directory</span> <span class="s1">'/var/www/my_flask_app/shared'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># for virtualenv</span>
<span class="n">directory</span> <span class="s1">'/var/www/my_flask_app/shared/.env2'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># for uwsgi socket and uwsgi config</span>
<span class="n">directory</span> <span class="s1">'/var/www/my_flask_app/shared/.uwsgi'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># required by ssh</span>
<span class="n">directory</span> <span class="s1">'/var/www/.ssh'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">recursive</span> <span class="kp">true</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># required by pip</span>
<span class="n">directory</span> <span class="s1">'/var/www/.cache'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">recursive</span> <span class="kp">true</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_dirrb-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_dir.rb</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>
</code></pre></div></div>

<h3 id="run-all-tests-1">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="install-python">Install Python</h2>

<h3 id="add-an-integration-test-1">Add an integration test</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="nx">test/integration/default/serverspec/my_app_python_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Add this code to <code class="language-plaintext highlighter-rouge">my_app_python_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_python'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="c1"># verify system python</span>
  <span class="n">describe</span> <span class="n">package</span><span class="p">(</span><span class="s1">'python'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify system pip</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'which pip'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">contain</span> <span class="s1">'/usr/local/bin/pip'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify system setuptools</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'which easy_install'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">contain</span> <span class="s1">'/usr/local/bin/easy_install'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify system virtualenv</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'which virtualenv'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">contain</span> <span class="s1">'/usr/local/bin/virtualenv'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify my_flask_app virtual environment</span>
  <span class="c1"># See `helpers/serverspec/type/virtualenv.rb`</span>
  <span class="n">describe</span> <span class="n">virtualenv</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/shared/.env2'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_virtualenv</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="create-virtualenv-serverspec-type">Create <code class="language-plaintext highlighter-rouge">virtualenv</code> serverspec type</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">test/integration/helpers/serverspec/type</span><span class="w">
</span><span class="n">touch</span><span class="w"> </span><span class="nx">test/integration/helpers/serverspec/type/virtualenv.rb</span><span class="w">
</span></code></pre></div></div>

<p>Paste this code into <code class="language-plaintext highlighter-rouge">virtualenv.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">##############################################################################</span>
<span class="c1"># You can find the original code at:</span>
<span class="c1"># &lt;https://github.com/jantman/serverspec-extended-types&gt;</span>
<span class="c1"># Licensed under the MIT License</span>
<span class="c1">##############################################################################</span>

<span class="c1"># Serverspec</span>
<span class="k">module</span> <span class="nn">Serverspec</span>
  <span class="c1"># Type</span>
  <span class="k">module</span> <span class="nn">Type</span>
    <span class="c1"># Virtualenv</span>
    <span class="k">class</span> <span class="nc">Virtualenv</span> <span class="o">&lt;</span> <span class="no">Base</span>
      <span class="c1"># Test whether this appears to be a working venv</span>
      <span class="c1">#</span>
      <span class="c1"># Tests performed:</span>
      <span class="c1"># - venv_path/bin/pip executable by owner?</span>
      <span class="c1"># - venv_path/bin/python executable by owner?</span>
      <span class="c1"># - venv_path/bin/activate readable by owner?</span>
      <span class="c1"># - 'export VIRTUAL_ENV' in venv_path/bin/activate?</span>
      <span class="c1">#</span>
      <span class="c1"># @example</span>
      <span class="c1">#   describe virtualenv('/path/to/venv') do</span>
      <span class="c1">#     it { should be_virtualenv }</span>
      <span class="c1">#   end</span>
      <span class="c1">#</span>
      <span class="c1"># @api public</span>
      <span class="c1"># @return [Boolean]</span>
      <span class="k">def</span> <span class="nf">virtualenv?</span>
        <span class="n">pip_path</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'pip'</span><span class="p">)</span>
        <span class="n">python_path</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'python'</span><span class="p">)</span>
        <span class="n">act_path</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'activate'</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">"grep -q 'export VIRTUAL_ENV' </span><span class="si">#{</span><span class="n">act_path</span><span class="si">}</span><span class="s2">"</span>

        <span class="vi">@runner</span><span class="p">.</span><span class="nf">check_file_is_executable</span><span class="p">(</span><span class="n">pip_path</span><span class="p">,</span> <span class="s1">'owner'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="vi">@runner</span><span class="p">.</span><span class="nf">check_file_is_executable</span><span class="p">(</span><span class="n">python_path</span><span class="p">,</span> <span class="s1">'owner'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="vi">@runner</span><span class="p">.</span><span class="nf">check_file_is_readable</span><span class="p">(</span><span class="n">act_path</span><span class="p">,</span> <span class="s1">'owner'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="vi">@runner</span><span class="p">.</span><span class="nf">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">).</span><span class="nf">exit_status</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Serverspec Type wrapper method for Serverspec::Type::Virtualenv</span>
    <span class="c1">#</span>
    <span class="c1"># @example</span>
    <span class="c1">#   describe virtualenv('/path/to/venv') do</span>
    <span class="c1">#     # tests here</span>
    <span class="c1">#   end</span>
    <span class="c1">#</span>
    <span class="c1"># @param name [String] the absolute path to the virtualenv root</span>
    <span class="c1">#</span>
    <span class="c1"># @api public</span>
    <span class="c1"># @return {Serverspec::Type::Virtualenv}</span>
    <span class="k">def</span> <span class="nf">virtualenv</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="no">Virtualenv</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kp">include</span> <span class="no">Serverspec</span><span class="o">::</span><span class="no">Type</span>
</code></pre></div></div>

<p>Add this line to <code class="language-plaintext highlighter-rouge">test/integration/helpers/serverspec/spec_helper.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'type/virtualenv'</span>
</code></pre></div></div>

<h3 id="reference-the-poise-python-cookbook">Reference the <code class="language-plaintext highlighter-rouge">poise-python</code> cookbook</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">metadata.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depends</span> <span class="s1">'poise-python'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.1'</span>
</code></pre></div></div>

<p>To get the latest version string, run <code class="language-plaintext highlighter-rouge">knife cookbook site show nginx</code>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">knife</span><span class="w"> </span><span class="nx">cookbook</span><span class="w"> </span><span class="nx">site</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">poise-python</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="nx">latest_version</span><span class="w">
</span><span class="n">latest_version:</span><span class="w">     </span><span class="nx">https://supermarket.chef.io/api/v1/cookbooks/poise-python/versions/1.2.1</span><span class="w">
</span></code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">name</span> <span class="s1">'my_flask_server'</span>
<span class="n">maintainer</span> <span class="s1">'The Authors'</span>
<span class="n">maintainer_email</span> <span class="s1">'you@example.com'</span>
<span class="n">license</span> <span class="s1">'all_rights'</span>
<span class="n">description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">long_description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">version</span> <span class="s1">'0.1.0'</span>

<span class="n">depends</span> <span class="s1">'apt'</span><span class="p">,</span> <span class="s1">'~&gt; 2.9.2'</span>
<span class="n">depends</span> <span class="s1">'poise-python'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.1'</span>
</code></pre></div></div>

<h3 id="write-the-my_app_python-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_python</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_python.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_python</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_python_spec.rb</span><span class="w">
</span></code></pre></div></div>
<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_python.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_python</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="c1"># See https://supermarket.chef.io/cookbooks/poise-python</span>

<span class="c1"># install python 2</span>
<span class="n">python_runtime</span> <span class="s1">'python_2'</span> <span class="k">do</span>
  <span class="n">version</span> <span class="s1">'2'</span>
<span class="k">end</span>

<span class="c1"># create my_flask_app virtual environment</span>
<span class="n">python_virtualenv</span> <span class="s1">'my_flask_app_env'</span> <span class="k">do</span>
  <span class="n">path</span> <span class="s1">'/var/www/my_flask_app/shared/.env2'</span>
  <span class="n">python</span> <span class="s1">'python_2'</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_python-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_python</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>
</code></pre></div></div>

<h3 id="run-all-tests-2">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="install-ssh-key">Install SSH Key</h2>

<h3 id="update-kitchenyml-1">Update <code class="language-plaintext highlighter-rouge">.kitchen.yml</code></h3>

<p>Add this code to <code class="language-plaintext highlighter-rouge">.kitchen.yml</code> under <code class="language-plaintext highlighter-rouge">provisioner</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">data_bags_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./data_bags"</span>
    <span class="na">encrypted_data_bag_secret_key_path</span><span class="pi">:</span> <span class="s">&lt;%= ENV['CHEF_DATA_BAG_SECRET'] %&gt;</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">driver</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vagrant</span>
  <span class="na">require_chef_omnibus</span><span class="pi">:</span> <span class="s">12.5.1</span>
  <span class="na">network</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">private_network"</span><span class="pi">,</span> <span class="pi">{</span><span class="nv">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dhcp"</span><span class="pi">}]</span>
  <span class="na">vagrantfiles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.kitchen.vagrant_cachier.rb</span>
    <span class="pi">-</span> <span class="s">.kitchen.vagrant_hostmanager.rb</span>

<span class="na">provisioner</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">chef_zero</span>
  <span class="na">data_bags_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./data_bags"</span>
  <span class="na">encrypted_data_bag_secret_key_path</span><span class="pi">:</span> <span class="s">&lt;%= ENV['CHEF_DATA_BAG_SECRET'] %&gt;</span>

<span class="na">platforms</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ubuntu-14.04</span>

<span class="na">suites</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">run_list</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">recipe[my_flask_server::default]</span>
    <span class="na">attributes</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="generate-a-data-bag-secret">Generate a Data Bag Secret</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">~/.chef</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">byte</span><span class="p">[](</span><span class="mi">512</span><span class="p">)</span><span class="w">
</span><span class="nv">$rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Security.Cryptography.RNGCryptoServiceProvider</span><span class="p">]::</span><span class="n">Create</span><span class="p">()</span><span class="o">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-File</span><span class="w"> </span><span class="s2">"~/.chef/chef_data_bag_secret"</span><span class="w"> </span><span class="nt">-encoding</span><span class="w"> </span><span class="s2">"UTF8"</span><span class="w">
</span><span class="p">[</span><span class="n">array</span><span class="p">]::</span><span class="n">Clear</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$key</span><span class="o">.</span><span class="nf">Length</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>This key will be used to encrypt sensitive cookbook information like SSH private keys. Make sure you store a copy of the <code class="language-plaintext highlighter-rouge">~/.chef/chef_data_bag_secret</code> file in a secure location.</p>

<h4 id="create-environment-variable">Create Environment Variable</h4>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$chef_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rvpa</span><span class="w"> </span><span class="s1">'~/.chef/chef_data_bag_secret'</span><span class="p">)</span><span class="o">.</span><span class="nf">Path</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CHEF_DATA_BAG_SECRET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$chef_secret</span><span class="w">
</span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">"CHEF_DATA_BAG_SECRET"</span><span class="p">,</span><span class="w"> </span><span class="nv">$chef_secret</span><span class="p">,</span><span class="w"> </span><span class="s2">"User"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<h3 id="generate-ssh-key">Generate SSH Key</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">~/.ssh</span><span class="w">
</span></code></pre></div></div>

<p>Make sure you use an empty passphrase.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pushd</span><span class="w">
</span><span class="nx">cd</span><span class="w"> </span><span class="nx">~/.ssh</span><span class="w">
</span><span class="n">ssh-keygen</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">id_my_flask_app_deploy</span><span class="w">
</span><span class="n">popd</span><span class="w"> 
</span></code></pre></div></div>

<p>If you have an existing key with a passphrase, remove the passphrase from a private key using code similar to:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ssh-keygen</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="s1">'PASSPHRASE'</span><span class="w"> </span><span class="nt">-N</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">id_deploy</span><span class="w">
</span></code></pre></div></div>

<h4 id="add-the-ssh-key-to-bitbucket">Add the SSH key to Bitbucket</h4>

<p>We will use Bitbucket to host the source code of our test application. Go ahead and fork the <a href="https://bitbucket.org/vkantchev/my_flask_app/src">my_flask_app</a> repository.</p>

<p>Then add the public part of the SSH key, <code class="language-plaintext highlighter-rouge">~/.ssh/id_my_flask_app_deploy.pub</code>, to your Bitbucket fork. See <a href="https://confluence.atlassian.com/bitbucket/use-deployment-keys-294486051.html">Use deployment keys</a> for more details.</p>

<h3 id="create-data-bag-item">Create Data Bag Item</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"
{
	"id" : "my_flask_app",
	"deploy_key" : "&lt;key&gt;"
}
"@</span><span class="w">
</span><span class="nv">$json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$json</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s2">"&lt;key&gt;"</span><span class="p">,</span><span class="w"> </span><span class="p">([</span><span class="n">io.file</span><span class="p">]::</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s2">".ssh/id_my_flask_app_deploy"</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">"</span><span class="se">`n</span><span class="s2">"</span><span class="p">,</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">io.file</span><span class="p">]::</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s2">".chef/my_flask_app.json"</span><span class="p">,</span><span class="w"> </span><span class="nv">$json</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="encrypt-data-bag-item">Encrypt Data Bag Item</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="o">.</span><span class="nx">/data_bags/secrets</span><span class="w">

</span><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">knife</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">bag</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">secrets</span><span class="w"> </span><span class="nx">~/.chef/my_flask_app.json</span><span class="w"> </span><span class="nt">-z</span><span class="w"> </span><span class="nt">--secret-file</span><span class="w"> </span><span class="p">(</span><span class="n">rvpa</span><span class="w"> </span><span class="nx">~/.chef/chef_data_bag_secret</span><span class="p">)</span><span class="o">.</span><span class="nf">Path</span><span class="w">
</span></code></pre></div></div>

<h3 id="create-ssh-wrapper-script">Create SSH Wrapper Script</h3>

<p>Create <code class="language-plaintext highlighter-rouge">files/default/wrap-ssh4git.sh</code> file:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">wrap-ssh-4-git.sh</span><span class="w">
</span></code></pre></div></div>

<p>Add this content to the <code class="language-plaintext highlighter-rouge">files/default/wrap-ssh-4-git.sh</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
ssh <span class="nt">-o</span> <span class="s2">"StrictHostKeyChecking=no"</span> <span class="nt">-i</span> <span class="s2">"/tmp/my_flask_app/ssh/id_my_flask_app_deploy"</span> <span class="nv">$1</span> <span class="nv">$2</span>
</code></pre></div></div>

<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>

<h3 id="add-an-integration-test-2">Add an integration test</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="nx">test/integration/default/serverspec/my_app_ssh_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Add this code to <code class="language-plaintext highlighter-rouge">my_app_ssh_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_ssh'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_file</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_mode</span> <span class="s1">'755'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/tmp/my_flask_app/ssh/id_my_flask_app_deploy'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_file</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_mode</span> <span class="s1">'600'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'www-data'</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_grouped_into</span> <span class="s1">'www-data'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="write-the-my_app_ssh-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_ssh</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_ssh.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_ssh</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_ssh_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_ssh.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_app_ssh</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">directory</span> <span class="s1">'/tmp/my_flask_app/ssh'</span> <span class="k">do</span>
  <span class="n">recursive</span> <span class="kp">true</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># copy git ssh wrapper</span>
<span class="n">cookbook_file</span> <span class="s1">'/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh'</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'wrap-ssh-4-git.sh'</span>
  <span class="n">mode</span> <span class="mo">0755</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># decrypt the private ssh key</span>
<span class="n">my_flask_app</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s1">'secrets'</span><span class="p">,</span> <span class="s1">'my_flask_app'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">my_flask_app</span><span class="p">[</span><span class="s1">'deploy_key'</span><span class="p">]</span>
  <span class="n">ruby_block</span> <span class="s1">'decrypt `id_my_flask_app_deploy` private ssh key'</span> <span class="k">do</span>
    <span class="n">block</span> <span class="k">do</span>
      <span class="n">f</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'/tmp/my_flask_app/ssh/id_my_flask_app_deploy'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">my_flask_app</span><span class="p">[</span><span class="s1">'deploy_key'</span><span class="p">])</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">end</span>

    <span class="n">not_if</span> <span class="k">do</span>
      <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="s1">'/tmp/my_flask_app/ssh/id_my_flask_app_deploy'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># change permissions</span>
  <span class="n">file</span> <span class="s1">'/tmp/my_flask_app/ssh/id_my_flask_app_deploy'</span> <span class="k">do</span>
    <span class="n">mode</span> <span class="mo">0600</span>
    <span class="n">user</span> <span class="s1">'www-data'</span>
    <span class="n">group</span> <span class="s1">'www-data'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_ssh-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_ssh</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_ssh'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_ssh'</span>
</code></pre></div></div>

<h3 id="run-all-tests-3">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="deploy-application-from-git">Deploy Application From Git</h2>

<p>The test application is available in the <a href="https://bitbucket.org/vkantchev/my_flask_app/src">my_flask_app</a> repository on Bitbucket. Make sure you have forked it, and configured your SSH key, as explained earlier in this tutorial.</p>

<h3 id="reference-the-git-cookbook">Reference the <code class="language-plaintext highlighter-rouge">git</code> cookbook</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">metadata.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depends</span> <span class="s1">'git'</span><span class="p">,</span> <span class="s1">'~&gt; 4.3.6'</span>
</code></pre></div></div>

<p>To get the latest version string, run <code class="language-plaintext highlighter-rouge">knife cookbook site show git</code>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">knife</span><span class="w"> </span><span class="nx">cookbook</span><span class="w"> </span><span class="nx">site</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">git</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="nx">latest_version</span><span class="w">
</span><span class="n">latest_version:</span><span class="w">     </span><span class="nx">https://supermarket.chef.io/api/v1/cookbooks/git/versions/4.3.6</span><span class="w">
</span></code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">name</span> <span class="s1">'my_flask_server'</span>
<span class="n">maintainer</span> <span class="s1">'The Authors'</span>
<span class="n">maintainer_email</span> <span class="s1">'you@example.com'</span>
<span class="n">license</span> <span class="s1">'all_rights'</span>
<span class="n">description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">long_description</span> <span class="s1">'Installs/Configures my_flask_server'</span>
<span class="n">version</span> <span class="s1">'0.1.0'</span>

<span class="n">depends</span> <span class="s1">'apt'</span><span class="p">,</span> <span class="s1">'~&gt; 2.9.2'</span>
<span class="n">depends</span> <span class="s1">'poise-python'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.1'</span>
<span class="n">depends</span> <span class="s1">'git'</span><span class="p">,</span> <span class="s1">'~&gt; 4.3.6'</span>
</code></pre></div></div>

<h3 id="add-an-integration-test-3">Add an integration test</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">touch</span><span class="w"> </span><span class="nx">test/integration/default/serverspec/my_app_deploy_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Add this code to <code class="language-plaintext highlighter-rouge">my_app_deploy_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_deploy'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="c1"># verify git deployment</span>
  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/current'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_symlink</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/current/app.py'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">exist</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify requirements.txt has been processed</span>
  <span class="c1"># i.e. local python packages like `Flask` have been installed</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/shared/.env2/bin/pip list'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">contain</span> <span class="s1">'Flask'</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="write-the-my_app_deploy-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_deploy</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_deploy.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_deploy</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_deploy_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_deploy.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_app_deploy</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'git::default'</span>

<span class="c1"># checkout app from git repo / master branch</span>
<span class="c1"># creates `releases`, and `current` directories</span>
<span class="c1"># links `current` to latest revision</span>
<span class="n">deploy_revision</span> <span class="s1">'/var/www/my_flask_app'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:deploy</span>

  <span class="n">repo</span> <span class="s1">'ssh://git@bitbucket.org/vkantchev/my_flask_app.git'</span>
  <span class="n">branch</span> <span class="s1">'master'</span>

  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>

  <span class="n">ssh_wrapper</span> <span class="s1">'/tmp/my_flask_app/ssh/wrap-ssh-4-git.sh'</span>

  <span class="n">purge_before_symlink</span> <span class="p">[]</span>
  <span class="n">create_dirs_before_symlink</span> <span class="p">[]</span>

  <span class="n">symlinks</span><span class="p">({})</span>

  <span class="n">migrate</span> <span class="kp">false</span>
  <span class="n">symlink_before_migrate</span><span class="p">({})</span>
<span class="k">end</span>

<span class="c1"># install python packages in `my_flask_app_env` via pip</span>
<span class="c1"># `my_flask_app_env` is defined in the `my_app_python.rb`</span>
<span class="n">pip_requirements</span> <span class="s1">'/var/www/my_flask_app/current/requirements.txt'</span> <span class="k">do</span>
  <span class="n">virtualenv</span> <span class="s1">'my_flask_app_env'</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_deploy-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_deploy</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_deploy'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_ssh'</span>
<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_deploy'</span>
</code></pre></div></div>

<h3 id="run-all-tests-4">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="install-uwsgi">Install uWSGI</h2>

<h3 id="add-an-integration-test-4">Add an integration test</h3>

<p>Create <code class="language-plaintext highlighter-rouge">test/integration/default/serverspec/my_app_uwsgi_spec.rb</code></p>

<p>Add this code to <code class="language-plaintext highlighter-rouge">my_app_uwsgi_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_uwsgi'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="c1"># verify uWSGI package</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'/var/www/my_flask_app/shared/.env2/bin/pip list'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">contain</span> <span class="s1">'uWSGI'</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify my_flask_app uWSGI serice</span>
  <span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="s1">'my_flask_app'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="create-uwsgi-python-config-file">Create uWSGI Python Config File</h3>

<p>Create <code class="language-plaintext highlighter-rouge">files/default/uwsgi/my_flask_app.ini</code> file:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">files/default/uwsgi</span><span class="w">
</span><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">uwsgi/my_flask_app.ini</span><span class="w">
</span></code></pre></div></div>

<p>Add this content to the <code class="language-plaintext highlighter-rouge">files/default/uwsgi/my_flask_app.ini</code>:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># See:
# http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html
# http://uwsgi-docs.readthedocs.org/en/latest/Upstart.html
# http://uwsgi-docs.readthedocs.org/en/latest/Options.html#plugin-python
</span><span class="nn">[uwsgi]</span>

<span class="c"># socket configuration
</span><span class="py">socket</span> <span class="p">=</span> <span class="s">/var/www/my_flask_app/shared/.uwsgi/my_flask_app.sock</span>
<span class="py">chmod-socket</span> <span class="p">=</span> <span class="s">664</span>
<span class="py">vacuum</span> <span class="p">=</span> <span class="s">true</span>

<span class="c"># process configuration
</span><span class="py">master</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">processes</span> <span class="p">=</span> <span class="s">2</span>
<span class="py">threads</span> <span class="p">=</span> <span class="s">4</span>
<span class="py">die-on-term</span> <span class="p">=</span> <span class="s">true</span>

<span class="c"># app configuration
</span>
<span class="c"># virtual environment
</span><span class="py">virtualenv</span> <span class="p">=</span> <span class="s">/var/www/my_flask_app/shared/.env2</span>

<span class="c"># call the app instance from the app.py module
</span><span class="py">chdir</span> <span class="p">=</span> <span class="s">/var/www/my_flask_app/current</span>
<span class="py">module</span> <span class="p">=</span> <span class="s">app</span>
<span class="py">callable</span> <span class="p">=</span> <span class="s">app</span>
</code></pre></div></div>

<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>

<h3 id="create-uwsgi-service-config-file">Create uWSGI Service Config File</h3>

<p>Create <code class="language-plaintext highlighter-rouge">files/default/uwsgi/my_flask_app.conf</code> file:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">uwsgi/my_flask_app.conf</span><span class="w">
</span></code></pre></div></div>

<p>Add this content to the <code class="language-plaintext highlighter-rouge">files/default/uwsgi/my_flask_app.conf</code>:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>description "uWSGI instance to serve my_flask_app"

start on runlevel [2345]
stop on runlevel [!2345]

setuid www-data
setgid www-data

script
  cd /var/www/my_flask_app/shared
  . .env2/bin/activate
  uwsgi --ini .uwsgi/my_flask_app.ini
end script
</code></pre></div></div>

<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>

<h3 id="write-the-my_app_uwsgi-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_uwsgi</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_uwsgi.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_uwsgi</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_uwsgi_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_uwsgi.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_app_uwsgi</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="c1"># Install the uwsgi package in virtual environment using pip</span>
<span class="c1"># See https://supermarket.chef.io/cookbooks/poise-python</span>

<span class="c1"># install uwsgi python package</span>
<span class="n">python_package</span> <span class="s1">'uwsgi'</span> <span class="k">do</span>
  <span class="n">virtualenv</span> <span class="s1">'my_flask_app_env'</span>
  <span class="n">user</span> <span class="s1">'www-data'</span>
  <span class="n">group</span> <span class="s1">'www-data'</span>
<span class="k">end</span>

<span class="c1"># my_flask_app uWSGI configuration</span>
<span class="n">cookbook_file</span> <span class="s1">'/var/www/my_flask_app/shared/.uwsgi/my_flask_app.ini'</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'uwsgi/my_flask_app.ini'</span>
  <span class="n">owner</span> <span class="s1">'root'</span>
  <span class="n">group</span> <span class="s1">'root'</span>
  <span class="n">mode</span> <span class="mo">0644</span>
<span class="k">end</span>

<span class="c1"># create my_flask_app uWSGI service</span>
<span class="n">cookbook_file</span> <span class="s1">'/etc/init/my_flask_app.conf'</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'uwsgi/my_flask_app.conf'</span>
  <span class="n">owner</span> <span class="s1">'root'</span>
  <span class="n">group</span> <span class="s1">'root'</span>
  <span class="n">mode</span> <span class="mo">0644</span>
<span class="k">end</span>

<span class="c1"># start my_flask_app uWSGI service</span>
<span class="n">service</span> <span class="s1">'my_flask_app'</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Upstart</span>
  <span class="n">supports</span> <span class="ss">status: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">restart: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">reload: </span><span class="kp">true</span>
  <span class="n">action</span> <span class="p">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_uwsgi-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_uwsgi</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_uwsgi'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_ssh'</span>
<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_deploy'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_uwsgi'</span>
</code></pre></div></div>

<h3 id="run-all-tests-5">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<h2 id="install-nginx">Install Nginx</h2>

<h3 id="add-an-integration-test-5">Add an integration test</h3>

<p>Rename <code class="language-plaintext highlighter-rouge">test/integration/default/serverspec/default_spec.rb</code> to <code class="language-plaintext highlighter-rouge">test/integration/default/serverspec/my_app_nginx_spec.rb</code></p>

<p>Replace the contents of <code class="language-plaintext highlighter-rouge">my_app_nginx_spec.rb</code> with this code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s1">'my_flask_server::my_app_nginx'</span> <span class="k">do</span>
  <span class="c1"># Serverspec examples can be found at</span>
  <span class="c1"># http://serverspec.org/resource_types.html</span>

  <span class="c1"># verify nginx package</span>
  <span class="n">describe</span> <span class="n">package</span><span class="p">(</span><span class="s1">'nginx'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># verify nginx serice</span>
  <span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="s1">'nginx'</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="create-nginx-site-file">Create Nginx Site File</h3>

<p>Create <code class="language-plaintext highlighter-rouge">files/default/nginx/my_flask_app</code> file:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">files/default/nginx</span><span class="w">
</span><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">nginx/my_flask_app</span><span class="w">
</span></code></pre></div></div>

<p>Add this content to the <code class="language-plaintext highlighter-rouge">files/default/nginx/my_flask_app</code>:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen 80 default_server;
  listen [::]:80 default_server ipv6only=on;

  # Make site accessible from http://localhost/
  server_name localhost;

  location / {
    include uwsgi_params;
    uwsgi_pass unix:/var/www/my_flask_app/shared/.uwsgi/my_flask_app.sock;
  }
}
</code></pre></div></div>

<p>IMPORTANT: Make sure the file uses Unix Line Ending (\n, LF) and UTF-8 encoding. Otherwise you may get weird errors when Chef client runs the script during deployment.</p>

<h3 id="write-the-my_app_nginx-recipe">Write the <code class="language-plaintext highlighter-rouge">my_app_nginx</code> recipe</h3>

<p>The first step is to create the recipe file, <code class="language-plaintext highlighter-rouge">my_app_nginx.rb</code>. Run the following command to generate it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="nx">my_app_nginx</span><span class="w">
</span><span class="n">rm</span><span class="w"> </span><span class="nx">spec/unit/recipes/my_app_nginx_spec.rb</span><span class="w">
</span></code></pre></div></div>

<p>Write out <code class="language-plaintext highlighter-rouge">recipes/my_app_nginx.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: my_nginx</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="c1"># install nginx</span>
<span class="n">package</span> <span class="s1">'nginx'</span> <span class="k">do</span>
  <span class="ss">:upgrade</span>
<span class="k">end</span>

<span class="c1"># start nginx service</span>
<span class="n">service</span> <span class="s1">'nginx'</span> <span class="k">do</span>
  <span class="n">supports</span> <span class="ss">status: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">restart: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">reload: </span><span class="kp">true</span>
  <span class="n">action</span> <span class="p">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># Uncomment to use a custom nginx.conf</span>
<span class="c1"># cookbook_file '/etc/nginx/nginx.conf' do</span>
<span class="c1">#   source 'nginx/nginx.conf'</span>
<span class="c1">#   mode 0640</span>
<span class="c1">#   owner 'root'</span>
<span class="c1">#   group 'root'</span>
<span class="c1">#   notifies :restart, 'service[nginx]'</span>
<span class="c1"># end</span>

<span class="c1"># disable default site</span>
<span class="n">link</span> <span class="s1">'/etc/nginx/sites-enabled/default'</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:delete</span>
  <span class="n">only_if</span> <span class="s1">'test -L /etc/nginx/sites-enabled/default'</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">'service[nginx]'</span>
<span class="k">end</span>

<span class="c1"># add my_flask_app site</span>
<span class="n">cookbook_file</span> <span class="s1">'/etc/nginx/sites-available/my_flask_app'</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'nginx/my_flask_app'</span>
  <span class="n">mode</span> <span class="mo">0640</span>
  <span class="n">owner</span> <span class="s1">'root'</span>
  <span class="n">group</span> <span class="s1">'root'</span>
<span class="k">end</span>

<span class="c1"># enable my_flask_app site</span>
<span class="n">link</span> <span class="s1">'/etc/nginx/sites-enabled/my_flask_app'</span> <span class="k">do</span>
  <span class="n">to</span> <span class="s1">'/etc/nginx/sites-available/my_flask_app'</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">'service[nginx]'</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="set-the-my_app_nginx-recipe-to-run">Set the <code class="language-plaintext highlighter-rouge">my_app_nginx</code> recipe to run</h3>

<p>Add this line to <code class="language-plaintext highlighter-rouge">recipes/default.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_nginx'</span>
</code></pre></div></div>

<p>Here is the complete file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Cookbook Name:: my_flask_server</span>
<span class="c1"># Recipe:: default</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2016 The Authors, All Rights Reserved.</span>

<span class="n">include_recipe</span> <span class="s1">'apt::default'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_dir'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_python'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_ssh'</span>
<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_deploy'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_uwsgi'</span>

<span class="n">include_recipe</span> <span class="s1">'my_flask_server::my_app_nginx'</span>
</code></pre></div></div>

<h3 id="run-all-tests-6">Run all tests</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chef</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nx">rake</span><span class="w">
</span></code></pre></div></div>

<p>Open a browser and navigate to <code class="language-plaintext highlighter-rouge">http://default-ubuntu-1404/</code>. You should see the “Hello World!” page of the my_flask application.</p>

  
    <hr>
    <div id="disqus_thread"></div>
    
    <noscript>Please enable JavaScript to view comments.</noscript>
  
</article>



<footer>
  <div>&copy; Swift Software Group</div>
  <nav><a aria-label="Mail" href="mailto:vkantchev@users.noreply.github.com" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#envelope"></use></svg></a><a aria-label="Github" href="https://github.com/swiftsoftwaregroup" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#github"></use></svg></a><a aria-label="Subscribe" href="/feed.xml" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#rss"></use></svg></a></nav>

</footer>


</html>
