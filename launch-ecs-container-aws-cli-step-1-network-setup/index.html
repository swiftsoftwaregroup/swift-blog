<!DOCTYPE html>
<html lang="en">
<head>  
<title>Launch ECS container using AWS CLI - Step 1 - Network Setup | Swift Software Group</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Swift Software Group">
<meta name="generator" content="Jekyll v4.2.2">
<link rel="canonical" href="/launch-ecs-container-aws-cli-step-1-network-setup/">


<link rel="stylesheet" href="/assets/css/frame.css">


<link rel="stylesheet" href="/assets/css/classes.css">

<link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Swift Software Group">



<script src="//swiftsoftwaregroup.disqus.com/embed.js" async></script>



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-37864402-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-37864402-1');
</script>

</head>




<header>
  <a href="https://swiftsoftwaregroup.com" class="title">Swift Software Group</a>
  <nav><a aria-label="Home" href="https://swiftsoftwaregroup.com/" ><span aria-hidden="true">Home</span></a><a aria-label="Services" href="https://swiftsoftwaregroup.com/services/" ><span aria-hidden="true">Services</span></a><a aria-label="Blog" href="/" ><span aria-hidden="true">Blog</span></a></nav>

</header>

<article>
  <header>
  <h1><a href="/launch-ecs-container-aws-cli-step-1-network-setup/">Launch ECS container using AWS CLI - Step 1 - Network Setup</a></h1><time datetime="2021-02-06T00:00:00-08:00">February 06, 2021</time>
</header>

  <p>Setup network infrastructure including new VPC (Virtual Private Cloud), public and private subnets, internet gateway, security group, and ssh access.</p>

<p>This is part of a multi-post thread involving these steps:</p>

<ol>
  <li>Network Setup (this post)</li>
  <li><a href="/launch-ecs-container-aws-cli-step-2-launch-ec2-instance">Launch EC2 Instance</a></li>
  <li><a href="/launch-ecs-container-aws-cli-step-3-create-docker-image">Create Docker Image</a></li>
  <li><a href="/launch-ecs-container-aws-cli-step-4-create-service">Create Service</a></li>
  <li><a href="/launch-ecs-container-aws-cli-step-5-cleanup">Cleanup</a></li>
</ol>

<p>Make sure you do this setup first:</p>

<ol>
  <li><a href="/setup-macos-for-aws-cloud-devops">Setup macOS for AWS Cloud DevOps</a></li>
  <li><a href="/aws-authentication">AWS Authentication</a></li>
</ol>

<h2 id="define-names">Define names</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VPC</span>
<span class="nv">vpc</span><span class="o">=</span><span class="s2">"vpc-ecs"</span>

<span class="c"># Subnets</span>
<span class="nv">subnet_1</span><span class="o">=</span><span class="s2">"subnet-ecs-1"</span>
<span class="nv">subnet_2</span><span class="o">=</span><span class="s2">"subnet-ecs-2"</span>

<span class="c"># Internet Gateway</span>
<span class="nv">internet_gateway</span><span class="o">=</span><span class="s2">"igw-ecs"</span>

<span class="c"># Route Table</span>
<span class="nv">route_table</span><span class="o">=</span><span class="s2">"rtb-ecs"</span>

<span class="c"># Security Group</span>
<span class="nv">security_group</span><span class="o">=</span><span class="s2">"security-ecs"</span>

<span class="c"># instance</span>
<span class="nv">instance</span><span class="o">=</span><span class="s2">"instance-ecs"</span>

<span class="c"># SSH access key</span>
<span class="nv">key</span><span class="o">=</span><span class="s2">"aws-ecs-key"</span>
</code></pre></div></div>

<h2 id="create-vpc">Create VPC</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VPC</span>

<span class="nb">echo</span> <span class="s2">"Create a VPC  (Virtual Private Cloud) ..."</span>

aws ec2 create-vpc <span class="se">\</span>
    <span class="nt">--cidr-block</span> 10.0.0.0/16  <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=vpc,Tags=[{Key=Name,Value='</span><span class="nv">$vpc</span><span class="s1">'}]'</span>

<span class="nv">vpc_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-vpcs <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$vpc</span> | jq <span class="nt">-r</span> <span class="s1">'.Vpcs[0].VpcId'</span><span class="si">)</span>
</code></pre></div></div>

<h2 id="create-subnets">Create Subnets</h2>

<p>Create 2 subnets in the VPC. First subnet will be our public interface. The second subnet will be private.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Subnets</span>
<span class="nb">echo</span> <span class="s2">"Create subnet 1 ..."</span>

aws ec2 create-subnet <span class="se">\</span>
    <span class="nt">--vpc-id</span> <span class="nv">$vpc_id</span> <span class="se">\</span>
    <span class="nt">--cidr-block</span> 10.0.0.0/24 <span class="se">\</span>
    <span class="nt">--availability-zone</span> us-west-2a <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value='</span><span class="nv">$subnet_1</span><span class="s1">'}]'</span>  

<span class="nv">subnet_1_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-subnets <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$subnet_1</span> | jq <span class="nt">-r</span> <span class="s1">'.Subnets[0].SubnetId'</span><span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"Create subnet 2 ..."</span>

aws ec2 create-subnet <span class="se">\</span>
    <span class="nt">--vpc-id</span> <span class="nv">$vpc_id</span> <span class="se">\</span>
    <span class="nt">--cidr-block</span> 10.0.1.0/24 <span class="se">\</span>
    <span class="nt">--availability-zone</span> us-west-2a <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value='</span><span class="nv">$subnet_2</span><span class="s1">'}]'</span>  

<span class="nv">subnet_2_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-subnets <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$subnet_2</span> | jq <span class="nt">-r</span> <span class="s1">'.Subnets[0].SubnetId'</span><span class="si">)</span>

<span class="c">## Automatically assign Elastic IP address after launch to all instances in subnet 1 </span>
aws ec2 modify-subnet-attribute <span class="nt">--subnet-id</span> <span class="nv">$subnet_1_id</span> <span class="nt">--map-public-ip-on-launch</span>
</code></pre></div></div>

<h2 id="create-internet-gateway">Create Internet Gateway</h2>

<p>Create an Internet gateway and attach it to the VPC. An internet gateway allows communication between your VPC and the Internet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Internet Gateway</span>

<span class="nb">echo</span> <span class="s2">"Create Internet Gateway ..."</span>

aws ec2 create-internet-gateway <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=internet-gateway,Tags=[{Key=Name,Value='</span><span class="nv">$internet_gateway</span><span class="s1">'}]'</span> 

<span class="nv">internet_gateway_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-internet-gateways <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$internet_gateway</span> | jq <span class="nt">-r</span> <span class="s1">'.InternetGateways[0].InternetGatewayId'</span><span class="si">)</span>

<span class="c">## Attach to VPC</span>
aws ec2 attach-internet-gateway <span class="nt">--vpc-id</span> <span class="nv">$vpc_id</span> <span class="nt">--internet-gateway-id</span> <span class="nv">$internet_gateway_id</span>
</code></pre></div></div>

<h2 id="create-route-table">Create Route Table</h2>

<p>Create a route table, associate it with the public subnet, and add a route to allow all traffic to the Internet gateway.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Route Table</span>

<span class="nb">echo</span> <span class="s2">"Create Route Table ..."</span>

aws ec2 create-route-table <span class="se">\</span>
    <span class="nt">--vpc-id</span> <span class="nv">$vpc_id</span> <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=route-table,Tags=[{Key=Name,Value='</span><span class="nv">$route_table</span><span class="s1">'}]'</span> 

<span class="nv">route_table_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-route-tables <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$route_table</span> | jq <span class="nt">-r</span> <span class="s1">'.RouteTables[0].RouteTableId'</span><span class="si">)</span>

<span class="c">## Associate with a subnet</span>
aws ec2 associate-route-table  <span class="nt">--subnet-id</span> <span class="nv">$subnet_1_id</span> <span class="nt">--route-table-id</span> <span class="nv">$route_table_id</span>

<span class="c">## Create a route in the route table that points all traffic (`0.0.0.0/0`) to the Internet gateway:</span>
aws ec2 create-route <span class="se">\</span>
    <span class="nt">--route-table-id</span> <span class="nv">$route_table_id</span> <span class="se">\</span>
    <span class="nt">--gateway-id</span> <span class="nv">$internet_gateway_id</span> <span class="se">\</span>
    <span class="nt">--destination-cidr-block</span> 0.0.0.0/0
</code></pre></div></div>

<h2 id="create-security-group">Create Security Group</h2>

<p>A <em>security group</em> controls the traffic that is allowed to reach and leave the resources that it is associated with. For example, after you associate a security group with a VPC, it controls the inbound and outbound traffic for the instances in the VPC.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Security Group</span>

<span class="nb">echo</span> <span class="s2">"Create a Security Group ..."</span>

aws ec2 create-security-group <span class="se">\</span>
    <span class="nt">--group-name</span> <span class="nv">$security_group</span> <span class="se">\</span>
    <span class="nt">--description</span> <span class="s2">"Security group for instance access"</span> <span class="se">\</span>
    <span class="nt">--vpc-id</span> <span class="nv">$vpc_id</span> <span class="se">\</span>
    <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=security-group,Tags=[{Key=Name,Value='</span><span class="nv">$security_group</span><span class="s1">'}]'</span> 
</code></pre></div></div>

<h2 id="allow-ssh-connections">Allow SSH Connections</h2>

<p>This is done by adding an ingress rule to the Security Group:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">group_id</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-security-groups <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>tag:Name,Values<span class="o">=</span><span class="nv">$security_group</span> | jq <span class="nt">-r</span> <span class="s1">'.SecurityGroups[0].GroupId'</span><span class="si">)</span>

<span class="c"># Add a rule that allows SSH access from anywhere:</span>
aws ec2 authorize-security-group-ingress <span class="se">\</span>
    <span class="nt">--group-id</span> <span class="nv">$group_id</span> <span class="se">\</span>
    <span class="nt">--protocol</span> tcp <span class="nt">--port</span> 22 <span class="nt">--cidr</span> 0.0.0.0/0
</code></pre></div></div>


  
    <hr>
    <div id="disqus_thread"></div>
    
    <noscript>Please enable JavaScript to view comments.</noscript>
  
</article>



<footer>
  <div>&copy; Swift Software Group</div>
  <nav><a aria-label="Mail" href="mailto:hello@swiftsoftwaregroup.com" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#envelope"></use></svg></a><a aria-label="Github" href="https://github.com/swiftsoftwaregroup" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#github"></use></svg></a><a aria-label="Subscribe" href="/feed.xml" ><svg aria-hidden="true" class="icon"><use xlink:href="/assets/fontawesome/icons.svg#rss"></use></svg></a></nav>

</footer>


</html>
